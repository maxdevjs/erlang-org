<!DOCTYPE html>
<html lang="en">



<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Allow pinning of website on windows -->
    <meta name="application-name" content="Erlang.org">
    <meta name="msapplication-tooltip" content="The official home of the Erlang Programming Language">
    <meta name="msapplication-starturl" content="/erlang-org/" >

    <!-- Make the site look nicer on facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Erlang.org">
    <meta property="og:title" content="Welcome to Erlang.org">
    <meta property="og:description" content="The official home of the Erlang Programming Language">
    <meta property="og:image" content="https://erlang.github.io/erlang-org/assets/img/erlang-228x200.png">
    <meta property="og:image:secure_url" content="https://erlang.github.io/erlang-org/assets/img/erlang-228x200.png">
    <meta property="og:url" content="https://erlang.github.io/erlang-org/">

    <!-- Twitter metadata -->
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="Index" />
    <meta name="twitter:site" content="@erlang_org" />

    <!-- Rich data for google search -->
    <script type="application/ld+json">
{"@type":"WebSite","url":"https://erlang.org/","headline":"Eep 0014 - Erlang/OTP","name":"Erlang.org","sameAs":["https://twitter.com/erlang_org","https://github.com/erlang/otp"],"@context":"https://schema.org"}</script>

    <title>Eep 0014 - Erlang/OTP</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- tells iOS browsers to not show telephone numbers as links -->
    <meta name="format-detection" content="telephone=no">

    <meta name="application-name" content="Erlang.org">
    <meta name="description" content="The official home of the Erlang Programming Language">
    <meta name="keywords" content="Erlang programming language functional parallel distributed documentation download community">
    <!-- https://www.rssboard.org/rss-autodiscovery -->
    <link rel="alternate" type="application/atom+xml" title="News Atom Feed" href="https://erlang.github.io/erlang-org/news.xml" />
    <link rel="alternate" type="application/atom+xml" title="Blog Atom Feed" href="https://erlang.github.io/erlang-org/blog.xml" />
    
    <link rel="stylesheet" href="/erlang-org/assets/css/main.css">
</head>

<body>
    <header class="navbar navbar-expand-lg navbar-light bg-body">
        <nav class="container">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand" href="/erlang-org/"><img
                    src="/erlang-org/assets/img/erlang.png" class="img-fluid" width="60" alt="Erlang.org main page"/></a>
            <div class="collapse navbar-collapse fw-bold" id="navbarSupportedContent">
                <ul class="navbar-nav text-uppercase me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/downloads">Download</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/docs">Documentation</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/community">Community</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/news">News</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/blog">Blog</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/eep">EEP</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/about">About</a></li>
                </ul>
                <form class="d-flex" role="search" method="post" action="https://duckduckgo.com/?kg=p"
                    onsubmit="document.getElementById('searchq').value = document.getElementById('searchfield').value + ' site:erlang.org'; return true;">
                    <input type="hidden" id="searchq" name="q" class="hidden" />
                    <input class="form-control me-2" id="searchfield" type="search" placeholder="Search erlang.org"
                        aria-label="Search">
                    <button class="btn btn-outline-primary" type="submit">Search</button>
                </form>
            </div>
        </nav>
    </header>
    <div class="container border-top pt-4">
    <div class="row-lg">
        <div class="col-lg-10 offset-lg-1">
            <div class="card">
                <div class="card-body">
                    <dl class="mb-0 dl-single">
                        <dt>Author:</dt>
                        <dd>
                            Richard A. O&#39;Keefe &lt;ok(at)cs(dot)otago(dot)ac(dot)nz&gt;
                            
                            
                        </dd>
                        
                        <dt>Status:</dt>
                        <dd>Draft </dd>
                        <dt>Type:</dt>
                        <dd>Standards Track</dd>
                        
                        
                        <dt>Created:</dt>
                        <dd>10-Jul-2008</dd>
                        
                        <dt>Erlang-Version:</dt>
                        <dd>R12B-4</dd>
                        
                        
                        
                        
                    </dl>
                </div>
            </div>
            <div class="border-top mt-4">
                <h2 id="eep-14-guard-clarification-and-extension">EEP 14: Guard clarification and extension</h2>

<h1 id="abstract">Abstract</h1>

<p>Allow Pattern = Guard_Expression as a simple guard test.
Make obviously silly guards syntax errors.</p>

<h1 id="specification">Specification</h1>

<p>Replace the opening text of section 6.24 “Guard Sequences”
as follows.</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">guard</span><span class="o">&gt;</span> <span class="p">::</span><span class="o">=</span> <span class="o">&lt;</span><span class="nv">OR</span> <span class="n">guard</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nv">OR</span> <span class="n">guard</span><span class="o">&gt;</span> <span class="p">::</span><span class="o">=</span> <span class="o">&lt;</span><span class="nv">AND</span> <span class="n">guard</span><span class="o">&gt;</span> <span class="p">{</span><span class="n">';'</span> <span class="o">&lt;</span><span class="nv">AND</span> <span class="n">guard</span><span class="o">&gt;</span><span class="p">}</span><span class="o">*</span>
</code></pre></div></div>

<p>An <code class="language-plaintext highlighter-rouge">&lt;OR guard&gt;</code> is a sequence of <code class="language-plaintext highlighter-rouge">&lt;AND guards&gt;</code> separated by
semicolons.  Here, as elsewhere in Erlang, semicolon means
sequential OR:  an <code class="language-plaintext highlighter-rouge">&lt;OR guard&gt;</code> evaluates its <code class="language-plaintext highlighter-rouge">&lt;AND guards&gt;</code>
one at a time from left to right, until one succeeds or
until all have failed.</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nv">AND</span> <span class="n">guard</span><span class="o">&gt;</span> <span class="p">::</span><span class="o">=</span> <span class="o">&lt;</span><span class="n">guard</span> <span class="n">test</span><span class="o">&gt;</span> <span class="p">{</span><span class="n">','</span> <span class="o">&lt;</span><span class="n">guard</span> <span class="n">test</span><span class="o">&gt;</span><span class="p">}</span><span class="o">*</span>
</code></pre></div></div>

<p>An <code class="language-plaintext highlighter-rouge">&lt;AND guard&gt;</code> is a sequence of <code class="language-plaintext highlighter-rouge">&lt;guard tests&gt;</code> separated by
semicolons.  Here, as is often the case in Erlang, comma
means sequential AND:  an <code class="language-plaintext highlighter-rouge">&lt;AND guard&gt;</code> evaluates its
<code class="language-plaintext highlighter-rouge">&lt;guard tests&gt;</code> one at a time from left to right, until all
have succeeded or one has failed.</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">guard</span> <span class="n">test</span><span class="o">&gt;</span> <span class="p">::</span><span class="o">=</span> <span class="o">&lt;</span><span class="n">guard</span> <span class="n">match</span><span class="o">&gt;</span>
              <span class="p">|</span> <span class="o">&lt;</span><span class="nv">Boolean</span> <span class="n">expression</span><span class="o">&gt;</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">guard</span> <span class="n">match</span><span class="o">&gt;</span> <span class="p">::</span><span class="o">=</span> <span class="o">&lt;</span><span class="n">pattern</span><span class="o">&gt;</span> <span class="n">'='</span> <span class="o">&lt;</span><span class="n">guard</span> <span class="n">expr</span><span class="o">&gt;</span>
               <span class="p">|</span>  <span class="o">&lt;</span><span class="n">pattern</span><span class="o">&gt;</span> <span class="n">'='</span> <span class="o">&lt;</span><span class="n">guard</span> <span class="n">match</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>A <code class="language-plaintext highlighter-rouge">&lt;guard test&gt;</code> is either a match or a Boolean expression.
In a guard, a match suceeds if and only if the <code class="language-plaintext highlighter-rouge">&lt;guard expr&gt;</code>
can be evaluated without exception, and the result can be
matched with the <code class="language-plaintext highlighter-rouge">&lt;pattern&gt;</code>, possibly binding some variables.</p>

<p>If a variable is bound in one <code class="language-plaintext highlighter-rouge">&lt;guard test&gt;</code>, it may be used in
later <code class="language-plaintext highlighter-rouge">&lt;guard test&gt;</code>s of the same <code class="language-plaintext highlighter-rouge">&lt;AND guard&gt;</code>.  If a variable
is bound in all of the <code class="language-plaintext highlighter-rouge">&lt;AND guard&gt;</code>s of an <code class="language-plaintext highlighter-rouge">&lt;OR guard&gt;</code> it may
be used in the guarded code, so</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span>  <span class="nv">X</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">is_atom</span><span class="p">(</span><span class="nb">element</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="nv">Tup</span><span class="p">))</span>
 <span class="p">;</span>  <span class="nv">X</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">is_atom</span><span class="p">(</span><span class="nb">element</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="nv">Tup</span><span class="p">))</span>
 <span class="o">-&gt;</span> <span class="p">...</span> <span class="n">uses</span> <span class="nv">X</span> <span class="p">...</span>
</code></pre></div></div>

<p>is OK.  If a variable is bound in one of the <code class="language-plaintext highlighter-rouge">&lt;AND guard&gt;</code>s of
an <code class="language-plaintext highlighter-rouge">&lt;OR guard&gt;</code> but not all of them it may not be used in the
guarded code, so</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span>  <span class="nv">X</span> <span class="o">=</span> <span class="n">a</span>
 <span class="p">;</span>  <span class="nv">Y</span> <span class="o">=</span> <span class="n">b</span>
 <span class="o">-&gt;</span> <span class="p">...</span> <span class="n">uses</span> <span class="nv">X</span> <span class="p">...</span>
</code></pre></div></div>

<p>is not allowed.</p>

<p>A <code class="language-plaintext highlighter-rouge">&lt;Boolean expression&gt;</code> in a guard consists of a number
of subexpressions</p>
<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">constant</span> <span class="n">'false'</span>
<span class="n">constant</span> <span class="n">'true'</span>
<span class="nf">variable</span> <span class="p">(</span><span class="n">must</span> <span class="n">be</span> <span class="n">bound</span> <span class="n">to</span> <span class="n">'false'</span> <span class="ow">or</span> <span class="n">'true'</span><span class="p">)</span>
<span class="n">term</span> <span class="n">comparison</span> <span class="n">with</span> <span class="err">`</span><span class="o">&lt;</span><span class="n">guard</span> <span class="n">expr</span><span class="o">&gt;</span><span class="err">`</span> <span class="n">operands</span>
<span class="n">calls</span> <span class="n">to</span> <span class="n">type</span> <span class="n">test</span> <span class="nv">BIFs</span> <span class="n">with</span> <span class="err">`</span><span class="o">&lt;</span><span class="n">guard</span> <span class="n">expr</span><span class="o">&gt;</span><span class="err">`</span> <span class="n">operands</span>
<span class="err">`</span><span class="o">&lt;</span><span class="nv">Boolean</span> <span class="n">expression</span><span class="o">&gt;</span><span class="err">`</span><span class="n">s</span> <span class="n">in</span> <span class="n">parentheses</span>
</code></pre></div></div>
<p>combined using the operators ‘not’, ‘and’, ‘or’,
‘andalso’, and ‘orelse’.  Thus</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">X</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="nv">Y</span>
</code></pre></div></div>

<p>is a <code class="language-plaintext highlighter-rouge">&lt;Boolean expression&gt;</code> that can be used as a <code class="language-plaintext highlighter-rouge">&lt;guard test&gt;</code>
but</p>
<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nv">X</span><span class="o">+</span><span class="mi">1</span>
</code></pre></div></div>

<p>is not.  You are advised never to use the ‘and’ and ‘or’ operators
and to avoid ‘andalso’ and ‘orelse’ whenever ‘,’ and ‘;’ will do
what you need.</p>

<p>The set of <code class="language-plaintext highlighter-rouge">&lt;guard expr&gt;</code>s is a subset of the set of valid Erlang
expressions.  The reason for restricting the set of valid
expressions is that evaluation of a guard expression must be
guaranteed to be free of side effects and to terminate.</p>

<p>A <code class="language-plaintext highlighter-rouge">&lt;guard expr&gt;</code> consists of a number of subexpressions</p>

<ul>
  <li>constants</li>
  <li>variables</li>
  <li>calls to “other BIFs Allowed in Guard Expressions”
(see table) with <code class="language-plaintext highlighter-rouge">&lt;guard expr&gt;</code> arguments</li>
  <li>record field selections</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;guard expr&gt;</code>s in parentheses</li>
</ul>

<p>combined using the built in arithmetic and bitwise operators.</p>

<h1 id="motivation">Motivation</h1>

<p>There are two parts to this EEP.  It was originally going to
be just about allowing matches in guards.  Then it was going
to be two, because the current situation is just too messy,
but then it became one again for brevity.</p>

<p>Consider this case.  A function is given a tuple and an index.
If the element at that index is in the range 0..127, it
should be returned.  Otherwise some other clause should apply.
Currently, we have to write</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">f</span><span class="p">(</span><span class="nv">Tuple</span><span class="p">,</span> <span class="nv">Index</span><span class="p">)</span>
    <span class="k">when</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nb">element</span><span class="p">(</span><span class="nv">Tuple</span><span class="p">,</span> <span class="nv">Index</span><span class="p">)),</span>
	 <span class="mi">0</span> <span class="o">=&lt;</span> <span class="nb">element</span><span class="p">(</span><span class="nv">Tuple</span><span class="p">,</span> <span class="nv">Index</span><span class="p">),</span>
	 <span class="nb">element</span><span class="p">(</span><span class="nv">Tuple</span><span class="p">,</span> <span class="nv">Index</span><span class="p">)</span> <span class="o">=&lt;</span> <span class="mi">127</span>
      <span class="o">-&gt;</span> <span class="nb">element</span><span class="p">(</span><span class="nv">Tuple</span><span class="p">,</span> <span class="nv">Index</span><span class="p">);</span>
<span class="p">...</span>
</code></pre></div></div>

<p>or something else which is even clumsier.  Why can’t we write</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">f</span><span class="p">(</span><span class="nv">Tuple</span><span class="p">,</span> <span class="nv">Index</span><span class="p">)</span>
    <span class="k">when</span> <span class="nv">X</span> <span class="o">=</span> <span class="nb">element</span><span class="p">(</span><span class="nv">Tuple</span><span class="p">,</span> <span class="nv">Index</span><span class="p">),</span>
         <span class="nb">is_integer</span><span class="p">(</span><span class="nv">X</span><span class="p">),</span> <span class="mi">0</span> <span class="o">=&lt;</span> <span class="nv">X</span><span class="p">,</span> <span class="nv">X</span> <span class="o">=&lt;</span> <span class="mi">127</span>
      <span class="o">-&gt;</span> <span class="nv">X</span><span class="p">;</span>
<span class="p">...</span>
</code></pre></div></div>

<p>In trying to explain how to add this to the language, I found
that the current description of guards in the Erlang reference
manual is remarkably fuzzy.  Dismayingly, this is matched
by an equally fuzzy implementation.  The description mixes
up things that can be used as arguments of guard BIFs
(guard expressions) with simple guards.</p>

<p>Consider the example</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">X</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="k">if</span> <span class="nv">X</span><span class="o">+</span><span class="mi">1</span> <span class="o">-&gt;</span> <span class="n">true</span>
 <span class="p">;</span> <span class="nv">X</span><span class="o">-</span><span class="mi">1</span> <span class="o">-&gt;</span> <span class="n">false</span>
<span class="k">end</span><span class="p">.</span>
</code></pre></div></div>

<p>This clearly makes no sense at all, and should be rejected
as bad syntax.  According to the current reference manual,
it is legal; X+1 and X-1 are legal “guard expressions”.</p>

<p>In the shell, this exampel crashes, which indeed makes
a lot of sense.  But ‘erlc’ says:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nv">X</span><span class="o">+</span><span class="mi">1</span><span class="p">}</span> <span class="nv">Warning</span><span class="p">:</span> <span class="n">the</span> <span class="n">guard</span> <span class="n">for</span> <span class="n">this</span> <span class="n">clause</span> <span class="n">evaluates</span> <span class="n">to</span> <span class="n">'false'</span>
<span class="p">{</span><span class="nv">X</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="nv">Warning</span><span class="p">:</span> <span class="n">the</span> <span class="n">guard</span> <span class="n">for</span> <span class="n">this</span> <span class="n">clause</span> <span class="n">evaluates</span> <span class="n">to</span> <span class="n">'false'</span>
</code></pre></div></div>

<p>It is good that there is a warning, but bad that the text of
the warning is wrong.  These things DON’T evaluate to ‘false’,
they evaluate to numbers.  Then, despite having given a warning,
you get a run-time error.</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">exited</span><span class="p">:</span> <span class="p">{</span><span class="n">if_clause</span><span class="p">,[{</span><span class="n">a</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">shell</span><span class="p">,</span><span class="n">exprs</span><span class="p">,</span><span class="mi">6</span><span class="p">},{</span><span class="n">shell</span><span class="p">,</span><span class="n">eval_loop</span><span class="p">,</span><span class="mi">3</span><span class="p">}]}</span>
</code></pre></div></div>

<p>What happened in this example, of course, was that all of the
clauses of the ‘if’ were eliminated because all of them were
malformed.  More realistic examples would simply quietly do the
wrong thing at run time.</p>

<h1 id="rationale">Rationale</h1>

<p>The syntax for allowing matches in guards is obvious;
no other syntax would be tolerable.  The only real question
is whether they can be embedded inside ‘andalso’ and ‘orelse’
or not, and in order to avoid questions of backtracking, I
have said “no”.  This is really the simplest extension of
guards to allow matches that I can think of.</p>

<p>The rest of the EEP is concerned with trying to rule out
obviously silly guard tests at compile time.  Precisely how
this is done is debateable.  That it should be done surely
isn’t.  What benefit do we currently obtain (other than
unwarranted simplicity in the compiler) from allowing “27”
and “X+5” as guards?</p>

<h1 id="backwards-compatibility">Backwards Compatibility</h1>

<p>Matches are currently not allowed in guards, so no existing
application code can be broken by adding them.  Obviously,
anything that works with Erlang parse trees will need to be
extended.</p>

<p>Cleaning up what’s allowed in guards may affect existing code.
However, in most cases the compiler would already have warned
about this, and the compatibility issue amounts to turning a
warning message into an error message.</p>

<h1 id="reference-implementation">Reference Implementation</h1>

<p>None.</p>

<h1 id="copyright">Copyright</h1>

<p>This document has been placed in the public domain.</p>


            </div>
        </div>
    </div>
</div>
<script src="/erlang-org/assets/js/prismjs/prism.js"></script>
<script src="/erlang-org/assets/js/prismjs/components/prism-erlang.js"></script>
    <footer class="container-fluid footer text-center border-top border-bottom">
        <div>
            <a href="/erlang-org/downloads.html" title="DOWNLOAD"><img src="/erlang-org/assets/img/download.png"></a>
        </div>
        <div>
            <a href="http://www.github.com/erlang/otp"><img
                    src="/erlang-org/assets/img/GitHub-Mark-32px.png"></a>
        </div>
        
        <div>
            <a href="http://www.twitter.com/erlang_org"><img src="/erlang-org/assets/img/twitter.png"
                    width="32"></a>
        </div>
    </footer>
    <script src="/erlang-org/assets/js/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>