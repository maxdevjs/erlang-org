<!DOCTYPE html>
<html lang="en">



<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Allow pinning of website on windows -->
    <meta name="application-name" content="Erlang.org">
    <meta name="msapplication-tooltip" content="The official home of the Erlang Programming Language">
    <meta name="msapplication-starturl" content="/erlang-org/" >

    <!-- Make the site look nicer on facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Erlang.org">
    <meta property="og:title" content="Welcome to Erlang.org">
    <meta property="og:description" content="The official home of the Erlang Programming Language">
    <meta property="og:image" content="https://erlang.github.io/erlang-org/assets/img/erlang-228x200.png">
    <meta property="og:image:secure_url" content="https://erlang.github.io/erlang-org/assets/img/erlang-228x200.png">
    <meta property="og:url" content="https://erlang.github.io/erlang-org/">

    <!-- Twitter metadata -->
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="Index" />
    <meta name="twitter:site" content="@erlang_org" />

    <!-- Rich data for google search -->
    <script type="application/ld+json">
{"@type":"WebSite","url":"https://erlang.org/","headline":"Eep 0056 - Erlang/OTP","name":"Erlang.org","sameAs":["https://twitter.com/erlang_org","https://github.com/erlang/otp"],"@context":"https://schema.org"}</script>

    <title>Eep 0056 - Erlang/OTP</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- tells iOS browsers to not show telephone numbers as links -->
    <meta name="format-detection" content="telephone=no">

    <meta name="application-name" content="Erlang.org">
    <meta name="description" content="The official home of the Erlang Programming Language">
    <meta name="keywords" content="Erlang programming language functional parallel distributed documentation download community">
    <!-- https://www.rssboard.org/rss-autodiscovery -->
    <link rel="alternate" type="application/atom+xml" title="News Atom Feed" href="https://erlang.github.io/erlang-org/news.xml" />
    <link rel="alternate" type="application/atom+xml" title="Blog Atom Feed" href="https://erlang.github.io/erlang-org/blog.xml" />
    
    <link rel="stylesheet" href="/erlang-org/assets/css/main.css">
</head>

<body>
    <header class="navbar navbar-expand-lg navbar-light bg-body">
        <nav class="container">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand" href="/erlang-org/"><img
                    src="/erlang-org/assets/img/erlang.png" class="img-fluid" width="60" alt="Erlang.org main page"/></a>
            <div class="collapse navbar-collapse fw-bold" id="navbarSupportedContent">
                <ul class="navbar-nav text-uppercase me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/downloads">Download</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/docs">Documentation</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/community">Community</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/news">News</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/blog">Blog</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/eep">EEP</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/about">About</a></li>
                </ul>
                <form class="d-flex" role="search" method="post" action="https://duckduckgo.com/?kg=p"
                    onsubmit="document.getElementById('searchq').value = document.getElementById('searchfield').value + ' site:erlang.org'; return true;">
                    <input type="hidden" id="searchq" name="q" class="hidden" />
                    <input class="form-control me-2" id="searchfield" type="search" placeholder="Search erlang.org"
                        aria-label="Search">
                    <button class="btn btn-outline-primary" type="submit">Search</button>
                </form>
            </div>
        </nav>
    </header>
    <div class="container border-top pt-4">
    <div class="row-lg">
        <div class="col-lg-10 offset-lg-1">
            <div class="card">
                <div class="card-body">
                    <dl class="mb-0 dl-single">
                        <dt>Author:</dt>
                        <dd>
                            Maria Scott &lt;maria-12648430(at)hnc-agency(dot)org&gt;
                            
                            , 
                            
                            
                            Jan Uhlig &lt;juhlig(at)hnc-agency(dot)org&gt;
                            
                            
                        </dd>
                        
                        <dt>Status:</dt>
                        <dd>Draft </dd>
                        <dt>Type:</dt>
                        <dd>Standards Track</dd>
                        
                        
                        <dt>Created:</dt>
                        <dd>04-Mar-2021</dd>
                        
                        <dt>Erlang-Version:</dt>
                        <dd>24.0</dd>
                        
                        
                        <dt>Post-History:</dt>
                        <dd>08-Mar-2021, 17-Mar-2021, 23-Mar-2021, 31-Mar-2021</dd>
                        
                        
                        
                    </dl>
                </div>
            </div>
            <div class="border-top mt-4">
                <h2 id="eep-56-automatic-supervisor-shutdown-triggered-by-termination-of-significant-children">EEP 56: Automatic supervisor shutdown triggered by termination of significant children</h2>

<h1 id="abstract">Abstract</h1>

<p>This EEP introduces a way of automatically terminating supervisors based
on the termination of specifically marked significant children.</p>

<p>This document is based on the discussion in <a href="https://github.com/erlang/otp/pull/4521" title="supervisor: add restart type intrinsic #4521">OTP-PR 4521</a>.</p>

<h1 id="motivation">Motivation</h1>

<p>Children under a supervisor often represent a work unit, that means, a group
of cooperating processes, as opposed to just a single process. Such work
unit supervisors (called group supervisors in the context of this document)
are themselves typically hosted by a simple_one_for_one supervisor, via
which they are started as needed.</p>

<p>At the time of this writing, however, there is no good, canonical way of
stopping such group supervisors once the work unit they represent has
finished it’s work and the respective child processes have terminated,
meaning the group supervisors will hang around, idle forever unless
stopped manually one way or another.</p>

<p>This has been addressed in applications in a variety of ways, none of which
can be called truly good, straightforward, or canonical:</p>

<ul>
  <li>Passing the Pid of the group supervisor to a child that is responsible for
shutting down that supervisor. The shutdown is then achieved by sending
an exit signal to the group supervisor. While the appropriate exit signals
are documented, it is not for this purpose, and flinging around exit signals
can be dangerous.</li>
  <li>Passing the Pid of the group supervisor and the Pid of the supervisor on top
of it to a child that is responsible for shutting down that supervisor.
The shutdown is then achieved by telling the supervisor on top to terminate
the group supervisor via <code class="language-plaintext highlighter-rouge">supervisor:terminate_child/2</code>. As this is a
blocking call, a process has to be spawned for it. Also, this will cause
the top supervisor to be blocked until the group supervisor has been shut
down, so it will not accept other requests until then.</li>
</ul>

<p>Both of the above approaches suffer from the fact that the children responsible
for the shutdown have to know things about their surroundings, namely…:</p>

<ul>
  <li>… that it is located under a (group) supervisor in the first place. In the
second of the above approaches, even that this group supervisor is again
located under yet another supervisor. And, conversely, it is not possible
to run this process independently (e.g. for testing), that is, without
the supervisor layers on top.</li>
  <li>… that it may have siblings, and that it is safe to cause their shutdown
by shutting down the supervisor. From a programmer’s perspective, it is not
obvious just by looking at the supervisor implementation that a certain
child may cause a shutdown of the supervisor and all children, so there is
a potential for surprises.</li>
</ul>

<p>This may be tackled by having a dedicated overseer child that watches the
other children and acts according to their behavior. However, this requires
considerable boilerplate code for tasks that would be better suited in the
supervisor. Also, there is the problem that the overseer process must keep
the list of children it watches up to date should any of them be restarted,
either by enabling the children to register with it on start (for which they
in turn must know the overseer process’ pid), or asking the supervisor
for it.</p>

<p>Another approach that is often used is to make the children responsible for
the shutdown of the group supervisor permanent and the supervisor’s restart
intensity to 0. This has the downside that the child will not be restarted
but cause the supervisor to shut down if it exits abnormally but <em>could</em>
be restarted. Another downside to this approach is that it produces error
messages (crash reports), even if the shutdown is intended.</p>

<p>Last but not least, some people have taken the approach to clone the OTP
supervisor and customize it to their needs, for reasons outlined here and
others.</p>

<h1 id="rationale">Rationale</h1>

<p>This EEP provides a means to alleviate the problems outlined in the
motivation by introducing a way to mark specific children as <code class="language-plaintext highlighter-rouge">significant</code>
via a new child spec flag, and a way to configure supervisors to shut down
automatically depending on the exit of significant children via a new
supervisor flag.</p>

<p>In order to keep backwards compatibility, the new flags will only be usable
in the map forms of child specs and supervisor flags, and for the same reason
the default values for the new flags are chosen such that, in their absence,
the supervisor behaves the same as it does to date.</p>

<p>The new child spec flag is named <code class="language-plaintext highlighter-rouge">significant</code> with possible values <code class="language-plaintext highlighter-rouge">true</code> and
<code class="language-plaintext highlighter-rouge">false</code>, with <code class="language-plaintext highlighter-rouge">false</code> being the default.</p>

<p>The new supervisor flag is named <code class="language-plaintext highlighter-rouge">auto_shutdown</code> with possible values <code class="language-plaintext highlighter-rouge">never</code>,
<code class="language-plaintext highlighter-rouge">any_significant</code> and <code class="language-plaintext highlighter-rouge">all_significant</code>, with <code class="language-plaintext highlighter-rouge">never</code> being the default.</p>

<p>With the supervisor <code class="language-plaintext highlighter-rouge">auto_shutdown</code> flag set to <code class="language-plaintext highlighter-rouge">never</code>, the child spec flag
<code class="language-plaintext highlighter-rouge">significant</code> is not allowed to be <code class="language-plaintext highlighter-rouge">true</code>. The <code class="language-plaintext highlighter-rouge">never</code> value and the restriction
on the <code class="language-plaintext highlighter-rouge">significant</code> value is intended as a safety means to defend against
unintended automatic shutdowns, for example by the exit of a significant child
which was added later via <code class="language-plaintext highlighter-rouge">supervisor:start_child/2</code>. As the spec for such a
child would not be present in the <code class="language-plaintext highlighter-rouge">supervisor:init/1</code> callback code but
somewhere else, debugging such unexplained supervisor shutdowns might be
difficult.</p>

<p>Otherwise, the following rules apply when a significant child exits <em>on its
own</em>:</p>

<ul>
  <li>A <code class="language-plaintext highlighter-rouge">transient</code> child will be restarted (not cause a supervisor shutdown)
if it exits abnormally. If it exits normally…
    <ul>
      <li>if the supervisor <code class="language-plaintext highlighter-rouge">auto_shutdown</code> flag is <code class="language-plaintext highlighter-rouge">any_significant</code>, the supervisor
will shut down</li>
      <li>if the supervisor <code class="language-plaintext highlighter-rouge">auto_shutdown</code> flag is <code class="language-plaintext highlighter-rouge">all_significant</code>, the supervisor
will shut down if the child was the last active significant child</li>
    </ul>
  </li>
  <li>A <code class="language-plaintext highlighter-rouge">temporary</code> child will never be restarted. If it exits normally or
abnormally, the same rules as for <code class="language-plaintext highlighter-rouge">transient</code> children apply, in regard to
the supervisor <code class="language-plaintext highlighter-rouge">auto_shutdown</code> flag.</li>
</ul>

<p>If the restart type is <code class="language-plaintext highlighter-rouge">permanent</code>, the <code class="language-plaintext highlighter-rouge">significant</code> flag is not allowed to
be <code class="language-plaintext highlighter-rouge">true</code>, as this combination does not make sense.</p>

<p>To be clear, the above rules only apply when <em>significant</em> children exit
<em>by themselves</em>, that is, not when being terminated manually via
<code class="language-plaintext highlighter-rouge">supervisor:terminate_child/2</code>, not when other non-significant children exit,
and not when being terminated as a consequence of a sibling’s death in the
<code class="language-plaintext highlighter-rouge">one_for_all</code> or <code class="language-plaintext highlighter-rouge">rest_for_one</code> strategies.</p>

<p>The approach proposed here could also be used to the effect of “shutdown when
empty” by marking <em>all</em> children as <code class="language-plaintext highlighter-rouge">significant</code> and setting the supervisor
<code class="language-plaintext highlighter-rouge">auto_shutdown</code> flag to <code class="language-plaintext highlighter-rouge">all_significant</code>.</p>

<p>It is worth mentioning that the <code class="language-plaintext highlighter-rouge">simple_one_for_one</code> strategy poses a special
case, as it can have only a single child spec that applies to all children.
That means that either <em>all</em> children are significant ones, or <em>none</em> is.</p>

<h1 id="considerations">Considerations</h1>

<p>Using temporary significant children in <code class="language-plaintext highlighter-rouge">one_for_all</code> and <code class="language-plaintext highlighter-rouge">rest_for_one</code>
supervisors may lead to an edge case scenario in which an intended automatic
shutdown will not happen. Temporary children will not be restarted, not even
when their termination was caused by a sibling’s death. On the other hand,
the automic shutdown of a supervisor is not triggered when a significant
child is terminated as a consequence of a sibling’s death. Thus, a temporary
significant child intended to automatically shut down it’s supervisor will
be lost if it is terminated as a consequence of a sibling’s death.</p>

<h1 id="backwards-compatibility">Backwards Compatibility</h1>

<p>The changes proposed in this document introduce no incompatible changes, as
the new child spec and supervisor flags are optional and default to values
that result in the current behavior. Also, all the current workarounds
outlined in the Motivation will still work.</p>

<p>Although the proposed changes are backwards compatible, applications using
this enhancement may not be compatible when compiled with previous OTP
versions unless proper care is taken.
Such an application compiled with older OTP versions will leak processes,
as the automatic supervisor shutdowns it relies on to remove unused parts of
it’s supervision tree will not happen.
Taking care of this issue is at the discretion of implementors if they expect
an application which uses the significant child behavior to be compiled
with an OTP version that predates it’s appearance.</p>

<h1 id="implementation">Implementation</h1>

<p>A reference implementation which will be updated to reflect the state of this
document can be found in <a href="https://github.com/erlang/otp/pull/4638" title="Reference implementation for EEP 56">OTP-PR 4638</a>.</p>

<h1 id="copyright">Copyright</h1>

<p>This document has been placed in the public domain.</p>


            </div>
        </div>
    </div>
</div>
<script src="/erlang-org/assets/js/prismjs/prism.js"></script>
<script src="/erlang-org/assets/js/prismjs/components/prism-erlang.js"></script>
    <footer class="container-fluid footer text-center border-top border-bottom">
        <div>
            <a href="/erlang-org/downloads.html" title="DOWNLOAD"><img src="/erlang-org/assets/img/download.png"></a>
        </div>
        <div>
            <a href="http://www.github.com/erlang/otp"><img
                    src="/erlang-org/assets/img/GitHub-Mark-32px.png"></a>
        </div>
        
        <div>
            <a href="http://www.twitter.com/erlang_org"><img src="/erlang-org/assets/img/twitter.png"
                    width="32"></a>
        </div>
    </footer>
    <script src="/erlang-org/assets/js/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>