<!DOCTYPE html>
<html lang="en">



<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Allow pinning of website on windows -->
    <meta name="application-name" content="Erlang.org">
    <meta name="msapplication-tooltip" content="The official home of the Erlang Programming Language">
    <meta name="msapplication-starturl" content="/erlang-org/" >

    <!-- Make the site look nicer on facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Erlang.org">
    <meta property="og:title" content="Welcome to Erlang.org">
    <meta property="og:description" content="The official home of the Erlang Programming Language">
    <meta property="og:image" content="https://erlang.github.io/erlang-org/assets/img/erlang-228x200.png">
    <meta property="og:image:secure_url" content="https://erlang.github.io/erlang-org/assets/img/erlang-228x200.png">
    <meta property="og:url" content="https://erlang.github.io/erlang-org/">

    <!-- Twitter metadata -->
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="Index" />
    <meta name="twitter:site" content="@erlang_org" />

    <!-- Rich data for google search -->
    <script type="application/ld+json">
{"@type":"WebSite","url":"https://erlang.org/","headline":"Eep 0037 - Erlang/OTP","name":"Erlang.org","sameAs":["https://twitter.com/erlang_org","https://github.com/erlang/otp"],"@context":"https://schema.org"}</script>

    <title>Eep 0037 - Erlang/OTP</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- tells iOS browsers to not show telephone numbers as links -->
    <meta name="format-detection" content="telephone=no">

    <meta name="application-name" content="Erlang.org">
    <meta name="description" content="The official home of the Erlang Programming Language">
    <meta name="keywords" content="Erlang programming language functional parallel distributed documentation download community">
    <!-- https://www.rssboard.org/rss-autodiscovery -->
    <link rel="alternate" type="application/atom+xml" title="News Atom Feed" href="https://erlang.github.io/erlang-org/news.xml" />
    <link rel="alternate" type="application/atom+xml" title="Blog Atom Feed" href="https://erlang.github.io/erlang-org/blog.xml" />
    
    <link rel="stylesheet" href="/erlang-org/assets/css/main.css">
</head>

<body>
    <header class="navbar navbar-expand-lg navbar-light bg-body">
        <nav class="container">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand" href="/erlang-org/"><img
                    src="/erlang-org/assets/img/erlang.png" class="img-fluid" width="60" alt="Erlang.org main page"/></a>
            <div class="collapse navbar-collapse fw-bold" id="navbarSupportedContent">
                <ul class="navbar-nav text-uppercase me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/downloads">Download</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/docs">Documentation</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/community">Community</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/news">News</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/blog">Blog</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/eep">EEP</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/about">About</a></li>
                </ul>
                <form class="d-flex" role="search" method="post" action="https://duckduckgo.com/?kg=p"
                    onsubmit="document.getElementById('searchq').value = document.getElementById('searchfield').value + ' site:erlang.org'; return true;">
                    <input type="hidden" id="searchq" name="q" class="hidden" />
                    <input class="form-control me-2" id="searchfield" type="search" placeholder="Search erlang.org"
                        aria-label="Search">
                    <button class="btn btn-outline-primary" type="submit">Search</button>
                </form>
            </div>
        </nav>
    </header>
    <div class="container border-top pt-4">
    <div class="row-lg">
        <div class="col-lg-10 offset-lg-1">
            <div class="card">
                <div class="card-body">
                    <dl class="mb-0 dl-single">
                        <dt>Author:</dt>
                        <dd>
                            Richard A. O&#39;Keefe &lt;ok(at)cs(dot)otago(dot)ac(dot)nz&gt;
                            
                            
                        </dd>
                        
                        <dt>Status:</dt>
                        <dd>Accepted </dd>
                        <dt>Type:</dt>
                        <dd>Standards Track</dd>
                        
                        <dt>Content-Type:</dt>
                        <dd>text/plain</dd>
                        
                        
                        <dt>Created:</dt>
                        <dd>27-May-2011</dd>
                        
                        <dt>Erlang-Version:</dt>
                        <dd>R14B04</dd>
                        
                        
                        
                        
                    </dl>
                </div>
            </div>
            <div class="border-top mt-4">
                <h2 id="eep-37-funs-with-names">EEP 37: Funs with names</h2>

<h1 id="abstract">Abstract</h1>

<p>The syntax of funs is extended to allow a variable name to
be consistently present before each argument list.  This
allows funs to be recursive.  The knot is tied in the
opcodes that apply a fun to its arguments, so no change to
the garbage collector design is required.</p>

<h1 id="specification">Specification</h1>

<p>Currently, there are three forms for a fun:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nv">Name</span><span class="o">/</span><span class="nv">Arity</span>
<span class="k">fun</span> <span class="nv">Module</span><span class="p">:</span><span class="nv">Name</span><span class="o">/</span><span class="nv">Arity</span>
</code></pre></div></div>

<p>and</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nv">Fun_Clause</span> <span class="p">{;</span> <span class="nv">Fun_Clause</span><span class="p">}...</span> <span class="k">end</span>
</code></pre></div></div>

<p>We add another form:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nv">Variable</span> <span class="nv">Fun_Clause</span> <span class="p">{;</span> <span class="nv">Variable</span> <span class="nv">Fun_Clause</span><span class="p">}...</span> <span class="k">end</span>
</code></pre></div></div>

<p>If any <code class="language-plaintext highlighter-rouge">Fun_Clause</code> has a <code class="language-plaintext highlighter-rouge">Variable</code>, all must, and they must all
be the same variable.  Like the variables in the argument list(s),
this variable is local to the fun, not shared with its context.
Within the fun, the variable is bound to the value of the fun
expression.</p>

<p>There are several possible ways to implement this.  One is
rather neat because it preserves the cycle-freedom of the
data structures the garbage collector has to deal with.</p>

<p>One way to implement existing funs is this:</p>

<ul>
  <li><strong>a</strong> Create an auxiliary function with a generated name</li>
</ul>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="o">&lt;</span><span class="n">foo</span><span class="o">&gt;</span><span class="p">(...,</span><span class="nv">X1</span><span class="p">,...,</span><span class="nv">Xk</span><span class="p">)</span> <span class="p">...;</span>
    <span class="p">...</span>
    <span class="o">&lt;</span><span class="n">foo</span><span class="o">&gt;</span><span class="p">(...,</span><span class="nv">X1</span><span class="p">,...,</span><span class="nv">Xk</span><span class="p">)</span> <span class="p">....</span>

<span class="n">having</span> <span class="n">the</span> <span class="n">same</span> <span class="n">argument</span> <span class="n">lists</span><span class="p">,</span> <span class="n">guards</span><span class="p">,</span> <span class="ow">and</span> <span class="n">clause</span> <span class="n">bodies</span>
<span class="n">as</span> <span class="n">the</span> <span class="k">fun</span><span class="p">,</span> <span class="n">except</span> <span class="n">that</span> <span class="n">each</span> <span class="n">variable</span> <span class="n">shared</span> <span class="n">with</span> <span class="n">the</span> <span class="n">context</span>
<span class="n">appears</span> <span class="n">as</span> <span class="n">an</span> <span class="n">extra</span> <span class="n">argument</span><span class="p">.</span>
</code></pre></div></div>

<ul>
  <li><strong>b</strong> Translate the fun expression as</li>
</ul>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nf">'%mk-fun'</span><span class="p">({</span><span class="k">fun</span> <span class="o">&lt;</span><span class="n">foo</span><span class="o">&gt;/</span><span class="n">n</span><span class="o">+</span><span class="n">k</span><span class="p">,</span> <span class="nv">X1</span><span class="p">,</span> <span class="p">...,</span> <span class="nv">Xk</span><span class="p">})</span>

<span class="n">which</span> <span class="n">gives</span> <span class="n">the</span> <span class="n">tuple</span> <span class="n">a</span> <span class="n">special</span> <span class="n">tag</span> <span class="n">to</span> <span class="n">say</span> <span class="n">that</span> <span class="n">it</span> <span class="n">represents</span>
<span class="n">a</span> <span class="k">fun</span> <span class="n">value</span><span class="p">.</span>
</code></pre></div></div>

<ul>
  <li><strong>c</strong> Translate  <code class="language-plaintext highlighter-rouge">Foo(E1,...,Em)</code>
  as <code class="language-plaintext highlighter-rouge">A1 := E1, ..., Am := Em; funcall_m(Foo)</code>
  where the <code class="language-plaintext highlighter-rouge">funcall_m</code> instruction checks that its argument is
  a closure expecting <code class="language-plaintext highlighter-rouge">m</code> arguments, moves the <code class="language-plaintext highlighter-rouge">X1,...,Xk</code> fields
  of the tuple to argument registers <code class="language-plaintext highlighter-rouge">A&lt;m+1&gt;..A&lt;m+k&gt;</code>, and then
  jumps to the address in the first field.</li>
</ul>

<p>All it takes to implement recursive funs is</p>

<ul>
  <li><strong>a’</strong> Create an auxiliary function</li>
</ul>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="o">&lt;</span><span class="n">foo</span><span class="o">&gt;</span><span class="p">(...,</span><span class="nv">X1</span><span class="p">,...,</span><span class="nv">Xk</span><span class="p">,</span><span class="nv">Variable</span><span class="p">)</span> <span class="p">...;</span>
    <span class="p">...</span>
    <span class="o">&lt;</span><span class="n">foo</span><span class="o">&gt;</span><span class="p">(...,</span><span class="nv">X1</span><span class="p">,...,</span><span class="nv">Xk</span><span class="p">,</span><span class="nv">Variable</span><span class="p">)</span> <span class="p">....</span>
</code></pre></div></div>

<ul>
  <li><strong>b’</strong> Translate the fun expression as</li>
</ul>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nf">'%mk-rec-fun'</span><span class="p">({</span><span class="k">fun</span> <span class="o">&lt;</span><span class="n">foo</span><span class="o">&gt;/&lt;</span><span class="n">n</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span> <span class="nv">X1</span><span class="p">,</span> <span class="p">...,</span> <span class="nv">Xk</span><span class="p">})</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">which</span> <span class="n">simply</span> <span class="n">applies</span> <span class="n">a</span> <span class="n">second</span> <span class="n">special</span> <span class="n">tag</span><span class="p">.</span>
</code></pre></div></div>

<ul>
  <li><strong>c’</strong> The <code class="language-plaintext highlighter-rouge">funcall_m</code> opcode acts the same for both old and
  recursive funs, except that just before jumping, it
  adds tne fun value <code class="language-plaintext highlighter-rouge">Foo</code> itself as argument <code class="language-plaintext highlighter-rouge">A&lt;m+k+1&gt;</code>.
  This “ties the knot”.</li>
</ul>

<p>So a recursive fun takes no more space or time to create than
an existing one, and does not involve creating any cycles of
pointers.  Its code can be inserted into the failure path for
the <code class="language-plaintext highlighter-rouge">funcall_m</code> instructions, whatever their form.</p>

<h1 id="motivation">Motivation</h1>

<p>Fun names can serve three purposes.</p>

<p>First, they can simply be documentation.  For example,</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">cfun_files</span><span class="p">(</span><span class="nv">CFun</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">fun</span><span class="p">(</span><span class="nv">F1</span><span class="p">,</span> <span class="nv">F2</span><span class="p">)</span> <span class="o">-&gt;</span>
	    <span class="p">[[</span><span class="o">?</span><span class="nv">OBJ</span><span class="p">(</span><span class="nv">T1</span><span class="p">,_)</span> <span class="p">|</span> <span class="p">_]</span> <span class="p">|</span> <span class="p">_]</span> <span class="o">=</span> <span class="nv">F1</span><span class="p">,</span>
	    <span class="p">[[</span><span class="o">?</span><span class="nv">OBJ</span><span class="p">(</span><span class="nv">T2</span><span class="p">,_)</span> <span class="p">|</span> <span class="p">_]</span> <span class="p">|</span> <span class="p">_]</span> <span class="o">=</span> <span class="nv">F2</span><span class="p">,</span>
	    <span class="nv">CFun</span><span class="p">(</span><span class="nv">T1</span><span class="p">,</span> <span class="nv">T2</span><span class="p">)</span>
    <span class="k">end</span><span class="p">.</span>
</code></pre></div></div>

<p>can be written as</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">cfun_files</span><span class="p">(</span><span class="nv">CFun</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">fun</span> <span class="nv">Compare</span><span class="p">([[</span><span class="o">?</span><span class="nv">OBJ</span><span class="p">(</span><span class="nv">T1</span><span class="p">,_)|_]|_],</span> <span class="p">[[</span><span class="o">?</span><span class="nv">OBJ</span><span class="p">(</span><span class="nv">T2</span><span class="p">,_)|_]|_])</span> <span class="o">-&gt;</span>
	<span class="nv">CFun</span><span class="p">(</span><span class="nv">T1</span><span class="p">,</span> <span class="nv">T2</span><span class="p">)</span>
    <span class="k">end</span><span class="p">.</span>
</code></pre></div></div>

<p>A named fun whose name is not used can be implemented as if
the name were not there.</p>

<p>Second, the fun’s name can be built into its generated name.
At the time of writing, we might have</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">'-F/N-fun-K-'</span>
</code></pre></div></div>

<p>where <code class="language-plaintext highlighter-rouge">F/N</code> is the name of the function that includes the fun
and <code class="language-plaintext highlighter-rouge">K</code> is the number of earlier funs in <code class="language-plaintext highlighter-rouge">F/N</code>.  We could build
the name in instead, using</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">'-F/N-fun-Name-[K-]'</span>
</code></pre></div></div>

<p>where <code class="language-plaintext highlighter-rouge">K</code> is present only if the outer function contains more
than one fun with the same name.  The point of this is that
such names are more likely to be useful after hot loading.
For example, if we start with</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">f</span><span class="p">(...</span><span class="nv">Xs</span><span class="p">,</span> <span class="nv">Ys</span><span class="p">,</span> <span class="p">...)</span> <span class="o">-&gt;</span>
    <span class="p">...</span>
    <span class="nf">sort</span><span class="p">(</span><span class="nv">Xs</span><span class="p">,</span> <span class="k">fun</span> <span class="nv">X_Key</span><span class="p">({_,</span><span class="nv">N</span><span class="p">,_})</span> <span class="o">-&gt;</span> <span class="nv">N</span> <span class="k">end</span><span class="p">),</span>
    <span class="nf">sort</span><span class="p">(</span><span class="nv">Ys</span><span class="p">,</span> <span class="k">fun</span> <span class="nv">Y_Key</span><span class="p">({</span><span class="nv">N</span><span class="p">,_,_})</span> <span class="o">-&gt;</span> <span class="nv">N</span> <span class="k">end</span><span class="p">),</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>and then we revise it, swapping the two calls to <code class="language-plaintext highlighter-rouge">sort/2</code>.
With named funs, the two funs retain their generated names,
and the module is safe.  With anonymous functions, the
chances are that the two funs with swap names; oops!</p>

<p>Third, a frequently asked question in the Erlang mailing
list is “why can’t I have recursive funs?” to which we
will now be able to rely, “you can; here is what they
look like.”</p>

<p>This still does not permit mutually recursive funs, but
people do not seem to ask for that much.</p>

<p>Finally, the next time someone argues that Erlang syntax
is inconsistent because function clauses have repeated
names and fun clauses do not, we shall be able to reply
“but fun clauses CAN have repeated names and probably
should.”</p>

<h1 id="rationale">Rationale</h1>

<p>There really seemed to be only two main questions.</p>

<p>What should the scope of the fun name variable be?
Some variables in a fun are shared between the fun
and its context.  Doing that would let us write</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">f</span><span class="p">(...)</span> <span class="o">-&gt;</span>
    <span class="k">fun</span> <span class="nv">G</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="p">...</span> <span class="k">end</span><span class="p">,</span>
    <span class="k">fun</span> <span class="nv">H</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="p">...</span> <span class="k">end</span><span class="p">,</span>
    <span class="p">...</span> <span class="n">use</span> <span class="nv">G</span> <span class="ow">and</span> <span class="nv">H</span> <span class="p">...</span>
</code></pre></div></div>

<p>rather like using nested “define” in Scheme, except that
while <code class="language-plaintext highlighter-rouge">H</code> could use <code class="language-plaintext highlighter-rouge">G</code>, <code class="language-plaintext highlighter-rouge">G</code> couldn’t use <code class="language-plaintext highlighter-rouge">H</code>.</p>

<p>Since you do not get mutual recursion this way, you should
not be tricked into thinking you might.  It’s better that
you have to write</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">f</span><span class="p">(...)</span> <span class="o">-&gt;</span>
    <span class="nv">GG</span> <span class="o">=</span> <span class="k">fun</span> <span class="nv">G</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="p">...</span> <span class="k">end</span><span class="p">,</span>
    <span class="nv">HH</span> <span class="o">=</span> <span class="k">fun</span> <span class="nv">H</span><span class="p">(...)</span> <span class="o">-&gt;</span> <span class="p">...</span> <span class="k">end</span><span class="p">,</span>
    <span class="p">...</span> <span class="n">use</span> <span class="nv">GG</span> <span class="ow">and</span> <span class="nv">HH</span> <span class="p">...</span>
</code></pre></div></div>

<p>so that you understand clearly what you are getting.</p>

<p>While variables in the body of a fun clause may be shared
with the context, variables in the arguments are not,
something I have found confusing.  At least this way the
fun name follows the same scope rule as the variables in
the argument list right next to it.</p>

<p>The other main question was whether recursive fun values
should be exactly the same representation as existing
fun values, but with a cycle in it (tying the knot at
construction time), or whether to introduce a new tag
(tying the knot at call time).  The lack of cycles in
Erlang heaps has been a major factor in the design of
several garbage collectors.  I would expect changing
that to be an order of magnitude harder than the
changes required for this proposal.  It was seeing that
the knot could be tied at call with (without slowing
down calls to existing funs) that made me dare to hope
that this proposal might some day be accepted.</p>

<p>The main issue now is that this does not let us define
a group of mutually recursive local functions.
Adopting this proposal now might get in the way of a
better proposal that handles mutual recursion as well.</p>

<p>I don’t see such a proposal as being likely to arrive soon.</p>

<p>There is a special case of this where the fun name is used
only in tail call positions, which can be handled entirely
by the compiler generating a jump back to the beginning.
This need not have any consequences for the run time system
at all.</p>

<h1 id="backwards-compatibility">Backwards Compatibility</h1>

<p>Code that does not use the new feature does not change its
meaning.  There may be code that relies on the form of
generated function names; that would need changing.</p>

<p>All syntax tools would need to be revised to handle the new form.
Existing parse transforms might well fail on code containing the
new form, but would work unchanged on code that does not.</p>

<p>At least one new instruction is needed to create suitably
distinguished closures.  Existing programs that analyse BEAM
files will not understand this until they are revised.</p>

<p>As described under ‘motivation’, naming functions is
useful even if you do not use the name in any clause body.
This means that we can have a staged delivery of the feature.</p>

<ol>
  <li>Make the parser recognise fun names and check their identity.
Have it report an error if the fun name is used in a body.
Have it erase the fun names from the AST before any
downstream tool sees it.</li>
</ol>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">At</span> <span class="n">this</span> <span class="n">stage</span><span class="p">,</span> <span class="k">fun</span> <span class="n">names</span> <span class="n">may</span> <span class="n">serve</span> <span class="n">as</span> <span class="n">documentation</span><span class="p">.</span>
</code></pre></div></div>

<ol>
  <li>Upgrade the downstream tools to recognise an extended <code class="language-plaintext highlighter-rouge">'fun'</code>
AST node with two extra fields:  the fun name as an atom and
a flag saying whether it is not used, used only in tail
position, or used more generally.</li>
</ol>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Upgrade</span> <span class="n">the</span> <span class="n">parser</span> <span class="n">to</span> <span class="n">report</span> <span class="k">fun</span> <span class="n">names</span><span class="p">,</span> <span class="n">but</span> <span class="n">retain</span> <span class="n">the</span>
<span class="n">check</span> <span class="n">that</span> <span class="n">they</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">used</span><span class="p">.</span>  <span class="nv">Test</span> <span class="n">the</span> <span class="n">down</span> <span class="n">stream</span> <span class="n">tools</span><span class="p">.</span>
</code></pre></div></div>

<ol>
  <li>Modify the compiler to use the new, safer, form of generated
name.  Ensure that the generated names are accessed only
through an interface, so all is consistent.</li>
</ol>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">At</span> <span class="n">this</span> <span class="n">stage</span><span class="p">,</span> <span class="k">fun</span> <span class="n">names</span> <span class="n">help</span> <span class="n">to</span> <span class="n">reduce</span> <span class="n">the</span> <span class="n">danger</span> <span class="n">from</span>
<span class="n">code</span> <span class="n">revisions</span> <span class="n">that</span> <span class="n">add</span><span class="p">,</span> <span class="n">remove</span><span class="p">,</span> <span class="ow">or</span> <span class="n">re</span><span class="o">-</span><span class="n">order</span> <span class="n">funs</span><span class="p">;</span> <span class="n">a</span>
<span class="n">change</span> <span class="n">that</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">alter</span> <span class="n">the</span> <span class="n">number</span> <span class="k">of</span> <span class="n">funs</span> <span class="n">with</span> <span class="n">a</span>
<span class="n">particular</span> <span class="n">name</span> <span class="n">in</span> <span class="n">a</span> <span class="n">function</span> <span class="n">should</span> <span class="ow">not</span> <span class="n">change</span> <span class="n">its</span> <span class="n">name</span><span class="p">.</span>
</code></pre></div></div>

<ol>
  <li>(Optional.)  Revise the code generator to accept the fun
name in tail call position and generate a jump.  Modify
the parser to allow this.</li>
</ol>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">At</span> <span class="n">this</span> <span class="n">point</span><span class="p">,</span> <span class="n">it</span> <span class="n">is</span> <span class="n">possible</span> <span class="n">to</span> <span class="n">pass</span> <span class="n">a</span> <span class="n">loop</span> <span class="n">as</span> <span class="n">a</span> <span class="n">parameter</span><span class="p">,</span>
<span class="n">like</span> <span class="n">a</span> <span class="n">list</span> <span class="n">traversal</span> <span class="ow">or</span> <span class="n">a</span> <span class="n">binary</span> <span class="n">search</span><span class="p">.</span>  <span class="nv">No</span> <span class="n">changes</span> <span class="n">to</span> <span class="n">the</span>
<span class="n">representation</span> <span class="k">of</span> <span class="nv">Erlang</span> <span class="n">terms</span> <span class="ow">or</span> <span class="n">the</span> <span class="nv">BEAM</span> <span class="n">engine</span> <span class="n">have</span> <span class="n">been</span>
<span class="n">required</span> <span class="n">yet</span><span class="p">.</span>
</code></pre></div></div>

<ol>
  <li>Add a new tag.  Revise the funcall instructions to check for
it if the existing check fails, and push the closure itself.
Add a new instruction to make a new closure.  Revise the
Erlang term representation to encode recursive funs.  Revise
the type test instructions to recognise the new values.
Teach HiPE what to do.</li>
</ol>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">This</span> <span class="n">is</span> <span class="n">the</span> <span class="n">last</span> <span class="n">stage</span><span class="p">.</span>
</code></pre></div></div>

<h1 id="reference-implementation">Reference Implementation</h1>

<p>None in this draft.  Stage 1 can be done fairly easily.
Stage 2 would be hard for me because I’m not even sure what
all the relevant modules are.</p>

<h1 id="references">References</h1>

<p>None.</p>

<h1 id="copyright">Copyright</h1>

<p>This document has been placed in the public domain.</p>


            </div>
        </div>
    </div>
</div>
<script src="/erlang-org/assets/js/prismjs/prism.js"></script>
<script src="/erlang-org/assets/js/prismjs/components/prism-erlang.js"></script>
    <footer class="container-fluid footer text-center border-top border-bottom">
        <div>
            <a href="/erlang-org/downloads.html" title="DOWNLOAD"><img src="/erlang-org/assets/img/download.png"></a>
        </div>
        <div>
            <a href="http://www.github.com/erlang/otp"><img
                    src="/erlang-org/assets/img/GitHub-Mark-32px.png"></a>
        </div>
        
        <div>
            <a href="http://www.twitter.com/erlang_org"><img src="/erlang-org/assets/img/twitter.png"
                    width="32"></a>
        </div>
    </footer>
    <script src="/erlang-org/assets/js/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>