<!DOCTYPE html>
<html lang="en">



<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Allow pinning of website on windows -->
    <meta name="application-name" content="Erlang.org">
    <meta name="msapplication-tooltip" content="The official home of the Erlang Programming Language">
    <meta name="msapplication-starturl" content="/erlang-org/" >

    <!-- Make the site look nicer on facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Erlang.org">
    <meta property="og:title" content="Welcome to Erlang.org">
    <meta property="og:description" content="The official home of the Erlang Programming Language">
    <meta property="og:image" content="https://erlang.github.io/erlang-org/assets/img/erlang-228x200.png">
    <meta property="og:image:secure_url" content="https://erlang.github.io/erlang-org/assets/img/erlang-228x200.png">
    <meta property="og:url" content="https://erlang.github.io/erlang-org/">

    <!-- Twitter metadata -->
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="Index" />
    <meta name="twitter:site" content="@erlang_org" />

    <!-- Rich data for google search -->
    <script type="application/ld+json">
{"@type":"WebSite","url":"https://erlang.org/","headline":"Eep 0044 - Erlang/OTP","name":"Erlang.org","sameAs":["https://twitter.com/erlang_org","https://github.com/erlang/otp"],"@context":"https://schema.org"}</script>

    <title>Eep 0044 - Erlang/OTP</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- tells iOS browsers to not show telephone numbers as links -->
    <meta name="format-detection" content="telephone=no">

    <meta name="application-name" content="Erlang.org">
    <meta name="description" content="The official home of the Erlang Programming Language">
    <meta name="keywords" content="Erlang programming language functional parallel distributed documentation download community">
    <!-- https://www.rssboard.org/rss-autodiscovery -->
    <link rel="alternate" type="application/atom+xml" title="News Atom Feed" href="https://erlang.github.io/erlang-org/news.xml" />
    <link rel="alternate" type="application/atom+xml" title="Blog Atom Feed" href="https://erlang.github.io/erlang-org/blog.xml" />
    
    <link rel="stylesheet" href="/erlang-org/assets/css/main.css">
</head>

<body>
    <header class="navbar navbar-expand-lg navbar-light bg-body">
        <nav class="container">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand" href="/erlang-org/"><img
                    src="/erlang-org/assets/img/erlang.png" class="img-fluid" width="60" alt="Erlang.org main page"/></a>
            <div class="collapse navbar-collapse fw-bold" id="navbarSupportedContent">
                <ul class="navbar-nav text-uppercase me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/downloads">Download</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/docs">Documentation</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/community">Community</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/news">News</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/blog">Blog</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/eep">EEP</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/about">About</a></li>
                </ul>
                <form class="d-flex" role="search" method="post" action="https://duckduckgo.com/?kg=p"
                    onsubmit="document.getElementById('searchq').value = document.getElementById('searchfield').value + ' site:erlang.org'; return true;">
                    <input type="hidden" id="searchq" name="q" class="hidden" />
                    <input class="form-control me-2" id="searchfield" type="search" placeholder="Search erlang.org"
                        aria-label="Search">
                    <button class="btn btn-outline-primary" type="submit">Search</button>
                </form>
            </div>
        </nav>
    </header>
    <div class="container border-top pt-4">
    <div class="row-lg">
        <div class="col-lg-10 offset-lg-1">
            <div class="card">
                <div class="card-body">
                    <dl class="mb-0 dl-single">
                        <dt>Author:</dt>
                        <dd>
                            Björn Gustavsson &lt;bjorn(at)erlang(dot)org&gt;
                            
                            
                        </dd>
                        
                        <dt>Status:</dt>
                        <dd>Accepted/19.0-we Proposal&#39;s -warning and -error directives are accepted to be implemented in OTP release 19.0</dd>
                        <dt>Type:</dt>
                        <dd>Standards Track</dd>
                        
                        
                        <dt>Created:</dt>
                        <dd>30-Sep-2015</dd>
                        
                        <dt>Erlang-Version:</dt>
                        <dd>R19</dd>
                        
                        
                        <dt>Post-History:</dt>
                        <dd>16-Oct-2015, 22-Oct-2015, 29-Oct-2015</dd>
                        
                        
                        
                    </dl>
                </div>
            </div>
            <div class="border-top mt-4">
                <h2 id="eep-44-additional-preprocessor-directives">EEP 44: Additional preprocessor directives</h2>

<h1 id="abstract">Abstract</h1>

<p>This EEP proposes extensions to the preprocessor to allow more
powerful conditional compilation.  The existing <code class="language-plaintext highlighter-rouge">-ifdef</code> directive
provides the bare minimum functionality for doing conditional
compilation, but it will often require help from external tools such
as <code class="language-plaintext highlighter-rouge">autoconf</code>.</p>

<h1 id="specification">Specification</h1>

<p>We will introduce a new predefined macro and four new preprocessor
directives.</p>

<h2 id="the-otp_release-macro">The OTP_RELEASE macro</h2>

<p>There will be a new predefined macro called <code class="language-plaintext highlighter-rouge">OTP_RELEASE</code>.  Its value
will be an integer giving the release number for run-time system that
is running the compiler.  In OTP 19, its value will be <code class="language-plaintext highlighter-rouge">19</code>.</p>

<p>Code that must work both in both OTP 18 and OTP 19 can use the
following construction:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">ifdef</span><span class="p">(</span><span class="nv">OTP_RELEASE</span><span class="p">).</span>
  <span class="c">%% Code that will work in OTP 19 or higher.
</span><span class="p">-</span><span class="ni">else</span><span class="p">.</span>
  <span class="c">%% Code that will work in OTP 18.
</span><span class="p">-</span><span class="ni">endif</span><span class="p">.</span>
</code></pre></div></div>

<p>From <code class="language-plaintext highlighter-rouge">OTP_RELEASE</code>, information about the <em>minimum</em> capabilities of
the run-time system can be inferred.  It is especially useful for
testing for the presence of major new features, especially language
features.</p>

<p>As a hypothetical example, assuming that OTP_RELEASE had been
available in OTP 17, if <code class="language-plaintext highlighter-rouge">?OTP_RELEASE == 17</code> evaluated to <code class="language-plaintext highlighter-rouge">true</code>,
we would know that maps were supported.</p>

<h2 id="the--if-and--elif-directives">The -if And -elif Directives</h2>

<p>The syntax for the new directives is as follows:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">if</span><span class="p">(</span><span class="nv">Expression</span><span class="p">).</span>
   <span class="p">.</span>
   <span class="p">.</span>
   <span class="p">.</span>
<span class="p">-</span><span class="ni">elif</span><span class="p">(</span><span class="nv">Expression</span><span class="p">).</span>
   <span class="p">.</span>
   <span class="p">.</span>
   <span class="p">.</span>
<span class="p">-</span><span class="ni">else</span><span class="p">.</span>
   <span class="p">.</span>
   <span class="p">.</span>
   <span class="p">.</span>
<span class="p">-</span><span class="ni">endif</span><span class="p">.</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">-elif</code> directive may be repeated any number of times.</p>

<p><em>Expression</em> is similar to the kind of expressions that are
allowed in guards, with a few differences:</p>

<ul>
  <li>
    <p>Only a single expression is allowed. <code class="language-plaintext highlighter-rouge">,</code> and ‘;’ may not be
used. Use <code class="language-plaintext highlighter-rouge">andalso</code> or <code class="language-plaintext highlighter-rouge">orelse</code> instead.</p>
  </li>
  <li>
    <p>In addition to the guard BIFs that are allowed in guards, there are
several additional functions allowed in the expression for an <code class="language-plaintext highlighter-rouge">-if</code> or
<code class="language-plaintext highlighter-rouge">-elif</code>. Those functions are described in the next section.</p>
  </li>
  <li>
    <p>Calls to unknown functions will not cause a compilation error,
but an evalution failure which will cause the lines that follows
the <code class="language-plaintext highlighter-rouge">-if</code> or <code class="language-plaintext highlighter-rouge">-elif</code> to be skipped.  See the Examples section for
an example to see why that is useful.  Calls to BIFs that are not
guard BIFs (such as <code class="language-plaintext highlighter-rouge">integer_to_list/1</code>) will cause a compilation
error.</p>
  </li>
</ul>

<h2 id="built-in-functions-in--if-elif">Built-In Functions in -if/-elif</h2>

<p>The following functions are available in <code class="language-plaintext highlighter-rouge">-if</code> and <code class="language-plaintext highlighter-rouge">-elif</code> expressions
(and <em>only</em> there):</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">defined(</code><em>Symbol</em><code class="language-plaintext highlighter-rouge">)</code></li>
  <li><code class="language-plaintext highlighter-rouge">is_deprecated(</code><em>Module</em><code class="language-plaintext highlighter-rouge">,</code> <em>Function</em><code class="language-plaintext highlighter-rouge">,</code> <em>Arity</em><code class="language-plaintext highlighter-rouge">)</code></li>
  <li><code class="language-plaintext highlighter-rouge">is_exported(</code><em>Module</em><code class="language-plaintext highlighter-rouge">,</code> <em>Function</em><code class="language-plaintext highlighter-rouge">,</code> <em>Arity</em><code class="language-plaintext highlighter-rouge">)</code></li>
  <li><code class="language-plaintext highlighter-rouge">is_header(</code><em>Header</em><code class="language-plaintext highlighter-rouge">)</code></li>
  <li><code class="language-plaintext highlighter-rouge">is_module(</code><em>Module</em><code class="language-plaintext highlighter-rouge">)</code></li>
  <li><code class="language-plaintext highlighter-rouge">version(</code><em>App</em><code class="language-plaintext highlighter-rouge">)</code></li>
</ul>

<p>Descriptions of each <code class="language-plaintext highlighter-rouge">if</code>-builtin follow.</p>

<h3 id="defined1">defined/1</h3>

<p><code class="language-plaintext highlighter-rouge">defined(</code><em>Symbol</em><code class="language-plaintext highlighter-rouge">)</code> tests whether the preprocessor symbol is
defined, just like <code class="language-plaintext highlighter-rouge">-ifdef(Symbol)</code>.</p>

<h3 id="is_deprecated3">is_deprecated/3</h3>

<p><code class="language-plaintext highlighter-rouge">is_deprecated(</code><em>Module</em><code class="language-plaintext highlighter-rouge">,</code> <em>Function</em><code class="language-plaintext highlighter-rouge">,</code> <em>Arity</em><code class="language-plaintext highlighter-rouge">)</code> tests whether
<em>Function</em><code class="language-plaintext highlighter-rouge">/</code><em>Arity</em> is deprecated.  It returns <code class="language-plaintext highlighter-rouge">true</code> if and only
if the compiler would generate a deprecated warning for the function.</p>

<p>To clarify, there are two ways that a function can be deprecated.</p>

<ul>
  <li>
    <p>One is by using the <code class="language-plaintext highlighter-rouge">-deprecated()</code> attribute.  This is what you use
to deprecate your functions, and the Xref tool knows about it.  The
compiler does not, and <code class="language-plaintext highlighter-rouge">is_deprecated/3</code> does not either.</p>
  </li>
  <li>
    <p>The other way is by listing the function in the compiler’s table of
deprecated functions in the <code class="language-plaintext highlighter-rouge">otp_internal</code> module.  This is what
<code class="language-plaintext highlighter-rouge">is_deprecated/3</code> consults.  <code class="language-plaintext highlighter-rouge">is_deprecated(M, F, A)</code> is true if and
only if <code class="language-plaintext highlighter-rouge">M:F/A</code> is listed in that table; the <code class="language-plaintext highlighter-rouge">nowarn_deprecated</code>
option has no effect on this decision.</p>
  </li>
</ul>

<h3 id="is_exported3">is_exported/3</h3>

<p><code class="language-plaintext highlighter-rouge">is_exported(</code><em>Module</em><code class="language-plaintext highlighter-rouge">,</code> <em>Function</em><code class="language-plaintext highlighter-rouge">,</code> <em>Arity</em><code class="language-plaintext highlighter-rouge">)</code> tests whether
<em>Function</em><code class="language-plaintext highlighter-rouge">/</code><em>Arity</em> is exported from <em>Module</em>.</p>

<p><em>Module</em> must already have been compiled.  <code class="language-plaintext highlighter-rouge">is_exported/3</code> will first
call <code class="language-plaintext highlighter-rouge">code:ensure_loaded/1</code> to load <em>Module</em> if it is not already
loaded.  If <em>Module</em> is not loaded and <code class="language-plaintext highlighter-rouge">code:ensure_loaded/1</code> fails to
load it, <code class="language-plaintext highlighter-rouge">is_exported/3</code> will return <code class="language-plaintext highlighter-rouge">false</code>.  When <em>Module</em> is known
to be loaded, <code class="language-plaintext highlighter-rouge">is_exported/3</code> will test whether the
<em>Function</em><code class="language-plaintext highlighter-rouge">/</code><em>Arity</em> is exported from <em>Module</em>.</p>

<h3 id="is_header1">is_header/1</h3>

<p><code class="language-plaintext highlighter-rouge">is_header(</code><em>Header</em><code class="language-plaintext highlighter-rouge">)</code> tests whether the header file <em>Header</em>
exists.  It searches for header files in the same way as
<code class="language-plaintext highlighter-rouge">-include_lib</code>.</p>

<h3 id="is_module1">is_module/1</h3>

<p><code class="language-plaintext highlighter-rouge">is_module(</code><em>Module</em><code class="language-plaintext highlighter-rouge">)</code> tests whether the module <em>Module</em> exists.</p>

<p><em>Module</em> must already have been compiled.  <code class="language-plaintext highlighter-rouge">is_module/1</code> will call
<code class="language-plaintext highlighter-rouge">code:ensure_loaded/1</code> to load <em>Module</em> if it is not already loaded.
If and only if <code class="language-plaintext highlighter-rouge">code:ensure_loaded/1</code> returns <code class="language-plaintext highlighter-rouge">{module,</code><em>Module</em><code class="language-plaintext highlighter-rouge">}</code>,
<code class="language-plaintext highlighter-rouge">is_module/1</code> will return <code class="language-plaintext highlighter-rouge">true</code>.</p>

<h3 id="version1">version/1</h3>

<p><code class="language-plaintext highlighter-rouge">version(</code><em>App</em><code class="language-plaintext highlighter-rouge">)</code> returns the version number for the given
application <em>App</em> as a list of integers and strings.</p>

<p>First the version number string will be split at each “.” to
produce a list of strings.  Then an attempt will be made to convert
each string in the list to an integer using <code class="language-plaintext highlighter-rouge">list_to_integer/1</code>.
If the conversion fails, the string will be kept.</p>

<p>Here is an example:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">"1.10.7"</span>
</code></pre></div></div>

<p>First the string will be split:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="s">"1"</span><span class="p">,</span><span class="s">"10"</span><span class="p">,</span><span class="s">"7"</span><span class="p">]</span>
</code></pre></div></div>

<p>Then each string in the list will be converted to an integer:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">]</span>
</code></pre></div></div>

<p>Here is another example:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">"1.6.0c"</span>
</code></pre></div></div>

<p>First the string will be split:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="s">"1"</span><span class="p">,</span><span class="s">"6"</span><span class="p">,</span><span class="s">"0c"</span><span class="p">]</span>
</code></pre></div></div>

<p>Then <code class="language-plaintext highlighter-rouge">version/1</code> will attempt to convert each string to an integer:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="s">"0c"</span><span class="p">]</span>
</code></pre></div></div>

<p>The last string is not numeric, so it is kept.</p>

<p>The version string is fetched from the app file for the application.
If the application cannot be found in the code path, or if the app
file cannot be read, or if there is no <code class="language-plaintext highlighter-rouge">vsn</code> record in the file, the
return value will be <code class="language-plaintext highlighter-rouge">[]</code>.</p>

<h2 id="the--error-directive">The -error Directive</h2>

<p>The syntax for the <code class="language-plaintext highlighter-rouge">-error</code> directive is:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">error</span><span class="p">(</span><span class="nv">Term</span><span class="p">).</span>
</code></pre></div></div>

<p>The directive will cause a compilation error. The error message
will look like:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">file</span><span class="p">.</span><span class="nn">erl</span><span class="p">:</span><span class="nv">Line</span><span class="p">:</span> <span class="o">-</span><span class="nf">error</span><span class="p">(</span><span class="nv">Term</span><span class="p">).</span>
</code></pre></div></div>

<p>Here is an example:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">example</span><span class="p">).</span>
<span class="p">-</span><span class="ni">error</span><span class="p">(</span><span class="s">"This is wrong"</span><span class="p">).</span>
<span class="p">-</span><span class="ni">error</span><span class="p">(</span><span class="n">wrong</span><span class="p">).</span>
<span class="p">-</span><span class="ni">error</span><span class="p">(</span><span class="s">"Macros will be expanded: "</span> <span class="o">?</span><span class="nv">MODULE_STRING</span><span class="p">).</span>
</code></pre></div></div>

<p>The error message will be:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">example</span><span class="p">.</span><span class="nn">erl</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span> <span class="o">-</span><span class="nf">error</span><span class="p">(</span><span class="s">"This is wrong"</span><span class="p">).</span>
<span class="n">example</span><span class="p">.</span><span class="nn">erl</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span> <span class="o">-</span><span class="nf">error</span><span class="p">(</span><span class="n">wrong</span><span class="p">).</span>
<span class="n">example</span><span class="p">.</span><span class="nn">erl</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span> <span class="o">-</span><span class="nf">error</span><span class="p">(</span><span class="s">"Macros will be expanded: example"</span><span class="p">).</span>
</code></pre></div></div>

<h2 id="the--warning-directive">The -warning Directive</h2>

<p>The syntax for the <code class="language-plaintext highlighter-rouge">-warning</code> directive is:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">warning</span><span class="p">(</span><span class="nv">Term</span><span class="p">).</span>
</code></pre></div></div>

<p>The directive will generate a warning, but the compilation will
continue.  The warning message will look like:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">file</span><span class="p">.</span><span class="nn">erl</span><span class="p">:</span><span class="nv">Line</span><span class="p">:</span> <span class="nv">Warning</span> <span class="o">-</span><span class="nf">warning</span><span class="p">(</span><span class="nv">Term</span><span class="p">).</span>
</code></pre></div></div>

<p>Here is an example:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">example</span><span class="p">).</span>
<span class="p">-</span><span class="ni">warning</span><span class="p">(</span><span class="s">"This module is obsolete"</span><span class="p">).</span>
<span class="p">-</span><span class="ni">warning</span><span class="p">(</span><span class="s">"Macros will be expanded: "</span> <span class="o">?</span><span class="nv">MODULE_STRING</span><span class="p">).</span>
</code></pre></div></div>

<p>The warning message will be:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">example</span><span class="p">.</span><span class="nn">erl</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span> <span class="nv">Warning</span><span class="p">:</span> <span class="o">-</span><span class="nf">warning</span><span class="p">(</span><span class="s">"This module is obsolete"</span><span class="p">).</span>
<span class="n">example</span><span class="p">.</span><span class="nn">erl</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span> <span class="nv">Warning</span><span class="p">:</span> <span class="o">-</span><span class="nf">warning</span><span class="p">(</span><span class="s">"Macros will be expanded: example"</span><span class="p">).</span>
</code></pre></div></div>

<h2 id="examples">Examples</h2>

<p>Here is an example of code that will work in OTP 18 through OTP 20.
There will be a compilation error if an attempt is made to compile
the code in OTP 21 or higher.</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">ifndef</span><span class="p">(</span><span class="nv">OTP_RELEASE</span><span class="p">).</span>
  <span class="c">%% Code that will work in OTP 18.
</span><span class="p">-</span><span class="ni">else</span><span class="p">.</span>
  <span class="c">%% OTP 19 or higher.
</span>  <span class="o">-</span><span class="k">if</span><span class="p">(</span><span class="o">?</span><span class="nv">OTP_RELEASE</span> <span class="o">=:=</span> <span class="mi">19</span><span class="p">).</span>
    <span class="c">%% Code that will work in OTP 19.
</span>  <span class="o">-</span><span class="nf">elif</span><span class="p">(</span><span class="o">?</span><span class="nv">OTP_RELEASE</span> <span class="o">=:=</span> <span class="mi">20</span><span class="p">).</span>
    <span class="c">%% Code that will work in OTP 20.
</span>  <span class="o">-</span><span class="n">else</span><span class="p">.</span>
    <span class="o">-</span><span class="nf">error</span><span class="p">(</span><span class="s">"Unsupported OTP release"</span><span class="p">).</span>
  <span class="o">-</span><span class="n">endif</span><span class="p">.</span>
<span class="p">-</span><span class="ni">endif</span><span class="p">.</span>
</code></pre></div></div>

<p>(Note that current versions of the preprocessor has partial support
for <code class="language-plaintext highlighter-rouge">-if</code> in that it can <em>skip</em> an <code class="language-plaintext highlighter-rouge">-if</code> … <code class="language-plaintext highlighter-rouge">-endif</code> construction.
Therefore this code example will work in OTP 18.)</p>

<p>Here is an hypothetical example showing how a problem could have
been solved in the past
(see <a href="http://erlang.org/pipermail/erlang-questions/2013-July/074542.html" title="predefined Erlang version macros">predefined Erlang version macros</a>).</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">if</span><span class="p">(</span><span class="nf">is_module</span><span class="p">(</span><span class="n">ssh_daemon_channel</span><span class="p">)).</span>
  <span class="c">%% R16B: use new ssh behaviour
</span>  <span class="o">-</span><span class="nf">behavior</span><span class="p">(</span><span class="n">ssh_daemon_channel</span><span class="p">).</span>
<span class="p">-</span><span class="ni">else</span><span class="p">.</span>
  <span class="c">%% R15: use old ssh behaviour
</span>  <span class="o">-</span><span class="nf">behaviour</span><span class="p">(</span><span class="n">ssh_channel</span><span class="p">).</span>
<span class="p">-</span><span class="ni">endif</span><span class="p">.</span>
</code></pre></div></div>

<p>Here is an example of dealing with a newly introduced header file.</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">if</span><span class="p">(</span><span class="nf">is_header</span><span class="p">(</span><span class="s">"stdlib/include/assert.hrl"</span><span class="p">)).</span>
  <span class="o">-</span><span class="nf">include_lib</span><span class="p">(</span><span class="s">"stdlib/include/assert.hrl"</span><span class="p">).</span>
<span class="p">-</span><span class="ni">else</span><span class="p">.</span>
  <span class="c">%% Define dummy macros just so that our code will compile.
</span>  <span class="o">-</span><span class="nf">define</span><span class="p">(</span><span class="nf">assert</span><span class="p">(</span><span class="nv">E</span><span class="p">),</span><span class="n">ok</span><span class="p">).</span>
  <span class="o">-</span><span class="nf">define</span><span class="p">(</span><span class="nf">assertNot</span><span class="p">(</span><span class="nv">E</span><span class="p">),</span><span class="n">ok</span><span class="p">).</span>
<span class="p">-</span><span class="ni">endif</span><span class="p">.</span>
</code></pre></div></div>

<p>Here is an hypothetical example showing how we could have tested
for the presence of maps:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">if</span><span class="p">(</span><span class="ow">not</span> <span class="nf">is_map</span><span class="p">(</span><span class="n">a</span><span class="p">)).</span>
  <span class="c">%% The guard BIF is_map/1 exists, i.e. maps are supported.
</span><span class="p">-</span><span class="ni">else</span><span class="p">.</span>
  <span class="c">%% No support for maps in this release.
</span><span class="p">-</span><span class="ni">endif</span><span class="p">.</span>
</code></pre></div></div>

<p>Note that <code class="language-plaintext highlighter-rouge">not is_map(a)</code> will evaluate to <code class="language-plaintext highlighter-rouge">true</code> if the <code class="language-plaintext highlighter-rouge">is_map/1</code> is
a supported guard BIF.  If <code class="language-plaintext highlighter-rouge">is_map/1</code> is not a supported guard BIF,
the call to <code class="language-plaintext highlighter-rouge">is_map/1</code> will generate an exception which will fail the
expression.</p>

<p>Here is an example involving the hypothetical <code class="language-plaintext highlighter-rouge">foobar</code> application.
Since it is not included in OTP, it might not have been compiled, and
<code class="language-plaintext highlighter-rouge">is_exported/3</code> could return <code class="language-plaintext highlighter-rouge">false</code> for the wrong reason.  To guard
against that, we will abort the compilation if the <code class="language-plaintext highlighter-rouge">foobar</code> module
does not exist:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">if</span><span class="p">(</span><span class="ow">not</span> <span class="nf">is_module</span><span class="p">(</span><span class="n">foobar</span><span class="p">)).</span>
<span class="p">-</span><span class="ni">error</span><span class="p">(</span><span class="s">"The foobar application has not been compiled"</span><span class="p">).</span>
<span class="p">-</span><span class="ni">endif</span><span class="p">.</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">if</span><span class="p">(</span><span class="nf">is_exported</span><span class="p">(</span><span class="n">foobar</span><span class="p">,</span> <span class="n">new_feature</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span>
<span class="c">%% Do something smart with the new feature.
</span><span class="p">-</span><span class="ni">else</span><span class="p">.</span>
<span class="c">%% Do as best as we can without the new feature.
</span><span class="p">-</span><span class="ni">endif</span><span class="p">.</span>
</code></pre></div></div>

<h1 id="motivation">Motivation</h1>

<p>It is common practice for many open-source applications (or libraries)
to work with at least two major releases of OTP: the current release
and the previous one.  An application may also have dependencies to
other third-party libraries and may need to work with different
versions of those.</p>

<p>Some applications may support several releases by refraining from
using features that are not available in both releases.  That may not
always be possible, depending on the purpose of the application. A
tool for pretty printing Erlang terms, for example, would not be very
useful if it didn’t support all data types in the release in which it
was running.</p>

<p>There is also another issue.  Modern applications are expected:</p>

<ul>
  <li>
    <p>To compile without any warnings.  Many developers use <code class="language-plaintext highlighter-rouge">-Werror</code> to
turn warnings into compilation errors.  That means that warnings
for deprecated functions must be suppressed or eliminated.  As an
example, the <code class="language-plaintext highlighter-rouge">now/0</code> BIF was marked as deprecated in OTP 18.
The recommended replacement BIFs were introduced in the same release.</p>
  </li>
  <li>
    <p>Not to cause any warnings in Dialyzer, and to have good type
specifications for all exported functions to help finding errors.
The type specifications must compile in all supported releases,
and must not cause warnings.</p>
  </li>
</ul>

<p>In many cases, the most practical solution for supporting several
OTP releases is conditional compilation, that is, if some condition
if fulfilled, one part of a source file will be compiled, and another
part if not.  For example, to handle the deprecation of <code class="language-plaintext highlighter-rouge">now/0</code>:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">ifdef</span><span class="p">(</span><span class="nv">NOW_DEPRECATED</span><span class="p">).</span>
  <span class="c">%% Use the recommended replacement functions.
</span>  <span class="nf">sys_time</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nn">erlang</span><span class="p">:</span><span class="nf">timestamp</span><span class="p">().</span>
  <span class="nf">uniq_name</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nv">Uniq</span> <span class="o">=</span> <span class="nn">erlang</span><span class="p">:</span><span class="nf">unique_integer</span><span class="p">([</span><span class="n">positive</span><span class="p">]),</span>
    <span class="nn">lists</span><span class="p">:</span><span class="nf">flatten</span><span class="p">(</span><span class="nn">io_lib</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">"name_</span><span class="si">~w</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="nv">Uniq</span><span class="p">]));</span>
<span class="p">-</span><span class="ni">else</span><span class="p">.</span>
  <span class="c">%% Use now/0.
</span>  <span class="nf">sys_time</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nf">now</span><span class="p">().</span>
  <span class="nf">uniq_name</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">C</span><span class="p">}</span> <span class="o">=</span> <span class="nf">now</span><span class="p">(),</span>
    <span class="nn">lists</span><span class="p">:</span><span class="nf">flatten</span><span class="p">(</span><span class="nn">io_lib</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">"name_</span><span class="si">~w</span><span class="s">_</span><span class="si">~w</span><span class="s">_</span><span class="si">~w</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">C</span><span class="p">])).</span>
<span class="p">-</span><span class="ni">endif</span><span class="p">.</span>
</code></pre></div></div>

<p>That approach works, but some external tool (for example <code class="language-plaintext highlighter-rouge">autoconf</code>)
will have to arrange for <code class="language-plaintext highlighter-rouge">-DNOW_DEPRECATED</code> to be added to the command
line for <code class="language-plaintext highlighter-rouge">erlc</code> if <code class="language-plaintext highlighter-rouge">now/0</code> has been deprecated.</p>

<p>Our suggestion for extending the preprocessor facilitates using
conditional compilation without any external tools. Assuming that
the extended preprocessor had been available earlier, the previous
example can be rewritten to:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">if</span><span class="p">(</span><span class="nf">is_exported</span><span class="p">(</span><span class="n">erlang</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)).</span>
  <span class="c">%% Use the recommended replacement functions.
</span>  <span class="nf">sys_time</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nn">erlang</span><span class="p">:</span><span class="nf">timestamp</span><span class="p">().</span>
  <span class="nf">uniq_name</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nv">Uniq</span> <span class="o">=</span> <span class="nn">erlang</span><span class="p">:</span><span class="nf">unique_integer</span><span class="p">([</span><span class="n">positive</span><span class="p">]),</span>
    <span class="nn">lists</span><span class="p">:</span><span class="nf">flatten</span><span class="p">(</span><span class="nn">io</span><span class="p">:</span><span class="nf">lib_format</span><span class="p">(</span><span class="s">"name_</span><span class="si">~w</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="nv">Uniq</span><span class="p">])).</span>
<span class="p">-</span><span class="ni">else</span><span class="p">.</span>
  <span class="c">%% Use now/0.
</span>  <span class="nf">sys_time</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nf">now</span><span class="p">().</span>
  <span class="nf">uniq_name</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">C</span><span class="p">}</span> <span class="o">=</span> <span class="nf">now</span><span class="p">(),</span>
    <span class="nn">lists</span><span class="p">:</span><span class="nf">flatten</span><span class="p">(</span><span class="nn">io</span><span class="p">:</span><span class="nf">lib_format</span><span class="p">(</span><span class="s">"name_</span><span class="si">~w</span><span class="s">_</span><span class="si">~w</span><span class="s">_</span><span class="si">~w</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">C</span><span class="p">])).</span>
<span class="p">-</span><span class="ni">endif</span><span class="p">.</span>
</code></pre></div></div>

<p>Alternatively, the first <code class="language-plaintext highlighter-rouge">-if</code> could have been written:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">if</span><span class="p">(</span><span class="nf">is_deprecated</span><span class="p">(</span><span class="n">erlang</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="mi">0</span><span class="p">)).</span>
</code></pre></div></div>

<h1 id="rationale">Rationale</h1>

<p>Preprocessors have a bad reputation, so why extend the preprocessor?</p>

<p>A quick <a href="https://www.google.com/?gfe_rd=cr&amp;q=preprocessor+evil&amp;gws_rd=cr#safe=off&amp;q=preprocessor+evil" title="preprocessor evil">Google search for “preprocessor evil”</a>
seems to indicate that it is the macro expansion in the preprocessor
that is considered evil, not the conditional compilation part.</p>

<p>That said, the major pitfall of conditional compilation is that the
code may be misbehave if it is run in a different environment than it
was compiled in.  This potential problem already exists with the
<code class="language-plaintext highlighter-rouge">-ifdef</code> directive in the current preprocessor.  It is the
responsibility of the user of conditional compilation to ensure that
the code is run in an environment compatible with the compilation
environment.</p>

<p>There is one thing a preprocessor, and only a preprocessor, can do:
skip code that is not syntactically correct (for example, code that
uses the map syntax).  Therefore, it seems that there is no way
getting around using a preprocessor.  We <em>could</em> invent a new
preprocessor, but that is not the purpose of this EEP.</p>

<p>What about feature detection instead of testing version numbers?</p>

<p>We are all for that.  Whenever possible, tests against version numbers
should be avoided if there is a better way.  For example, to test
whether the new behavior <code class="language-plaintext highlighter-rouge">ssh_daemon_channel</code> exists, use
<code class="language-plaintext highlighter-rouge">is_module(ssh_daemon_channel)</code>.</p>

<p>Would it not be better to have a built-in <code class="language-plaintext highlighter-rouge">supported</code> function to test
for language-related features instead of testing for the OTP release
number?</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">if</span><span class="p">(</span><span class="nf">supported</span><span class="p">(</span><span class="n">maps</span><span class="p">)).</span>
<span class="c">%% Map code.
</span><span class="p">-</span><span class="ni">endif</span><span class="p">.</span>
</code></pre></div></div>

<p>Perhaps.  It seems that for this to work the list of supported feature
names accepted by <code class="language-plaintext highlighter-rouge">supported</code> must be carefully maintained and
documented for each release.  The users must then look up the
appropriate feature name to use.  It may also not be obvious how to
name minor changes to the type specification syntax or to the language
itself.  The resulting code may not be any easier to understand than a
test against a release number.</p>

<h3 id="rationale-for-allowing-unknown-functions-in-expressions">Rationale for allowing unknown functions in expressions</h3>

<p>The rules for expressions says that the following example is legal
because <code class="language-plaintext highlighter-rouge">foobar/0</code> is an unknown function:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">if</span><span class="p">(</span><span class="nf">foobar</span><span class="p">()).</span>
<span class="c">%% Always skipped.
</span><span class="p">-</span><span class="ni">endif</span><span class="p">.</span>
</code></pre></div></div>

<p>The reason is that otherwise some expressions would be legal in
some releases but not others.  For example, <code class="language-plaintext highlighter-rouge">-if(is_map(a))</code> would
be legal in OTP releases that support maps, but cause a compilation
error in other releases.  Also, as a side effect, testing guard
BIFs can be used to test for new features instead of testing
<code class="language-plaintext highlighter-rouge">OTP_RELEASE</code>.</p>

<h1 id="backwards-compatibility">Backwards Compatibility</h1>

<p>Modules that define the <code class="language-plaintext highlighter-rouge">OTP_RELEASE</code> macro will fail to compile
with a message similar to this:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">example</span><span class="p">.</span><span class="nn">erl</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span> <span class="n">redefining</span> <span class="n">predefined</span> <span class="n">macro</span> <span class="n">'OTP_RELEASE'</span>
</code></pre></div></div>

<p>Similarly, attempting to define <code class="language-plaintext highlighter-rouge">OTP_RELEASE</code> from the command
line using <code class="language-plaintext highlighter-rouge">-D</code> will also fail.</p>

<p>Modules that has attributes that looks like <code class="language-plaintext highlighter-rouge">-error(Term)</code> or
<code class="language-plaintext highlighter-rouge">-warning(Term)</code> will need to be updated, as <code class="language-plaintext highlighter-rouge">-error(Term)</code> will
now cause a compilation error and <code class="language-plaintext highlighter-rouge">-warning(Term)</code> will cause
a compilation warning.</p>

<p>The function <code class="language-plaintext highlighter-rouge">epp:parse_erl_form/1</code> can now return <code class="language-plaintext highlighter-rouge">{warning,Info}</code> in
addition to its previous return values.  Applications that call
<code class="language-plaintext highlighter-rouge">epp:parse_erl_form/1</code> will need to be updated to handle the new
return value.  Similarly, the <code class="language-plaintext highlighter-rouge">epp:parse_file()</code> family of functions
can now include <code class="language-plaintext highlighter-rouge">{warning,Info}</code> tuples in the returned list of forms.</p>

<h1 id="implementation">Implementation</h1>

<p>The reference implementation can be fetched from Github like this:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">git</span> <span class="n">fetch</span> <span class="nn">git</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">bjorng</span><span class="o">/</span><span class="n">otp</span><span class="p">.</span><span class="n">git</span> <span class="n">bjorn</span><span class="o">/</span><span class="n">preprocessor</span><span class="o">-</span><span class="n">extensions</span>
</code></pre></div></div>

<h1 id="copyright">Copyright</h1>

<p>This document has been placed in the public domain.</p>


            </div>
        </div>
    </div>
</div>
<script src="/erlang-org/assets/js/prismjs/prism.js"></script>
<script src="/erlang-org/assets/js/prismjs/components/prism-erlang.js"></script>
    <footer class="container-fluid footer text-center border-top border-bottom">
        <div>
            <a href="/erlang-org/downloads.html" title="DOWNLOAD"><img src="/erlang-org/assets/img/download.png"></a>
        </div>
        <div>
            <a href="http://www.github.com/erlang/otp"><img
                    src="/erlang-org/assets/img/GitHub-Mark-32px.png"></a>
        </div>
        
        <div>
            <a href="http://www.twitter.com/erlang_org"><img src="/erlang-org/assets/img/twitter.png"
                    width="32"></a>
        </div>
    </footer>
    <script src="/erlang-org/assets/js/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>