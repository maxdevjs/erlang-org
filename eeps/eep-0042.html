<!DOCTYPE html>
<html lang="en">



<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Allow pinning of website on windows -->
    <meta name="application-name" content="Erlang.org">
    <meta name="msapplication-tooltip" content="The official home of the Erlang Programming Language">
    <meta name="msapplication-starturl" content="/erlang-org/" >

    <!-- Make the site look nicer on facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Erlang.org">
    <meta property="og:title" content="Welcome to Erlang.org">
    <meta property="og:description" content="The official home of the Erlang Programming Language">
    <meta property="og:image" content="https://erlang.github.io/erlang-org/assets/img/erlang-228x200.png">
    <meta property="og:image:secure_url" content="https://erlang.github.io/erlang-org/assets/img/erlang-228x200.png">
    <meta property="og:url" content="https://erlang.github.io/erlang-org/">

    <!-- Twitter metadata -->
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="Index" />
    <meta name="twitter:site" content="@erlang_org" />

    <!-- Rich data for google search -->
    <script type="application/ld+json">
{"@type":"WebSite","url":"https://erlang.org/","headline":"Eep 0042 - Erlang/OTP","name":"Erlang.org","sameAs":["https://twitter.com/erlang_org","https://github.com/erlang/otp"],"@context":"https://schema.org"}</script>

    <title>Eep 0042 - Erlang/OTP</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- tells iOS browsers to not show telephone numbers as links -->
    <meta name="format-detection" content="telephone=no">

    <meta name="application-name" content="Erlang.org">
    <meta name="description" content="The official home of the Erlang Programming Language">
    <meta name="keywords" content="Erlang programming language functional parallel distributed documentation download community">
    <!-- https://www.rssboard.org/rss-autodiscovery -->
    <link rel="alternate" type="application/atom+xml" title="News Atom Feed" href="https://erlang.github.io/erlang-org/news.xml" />
    <link rel="alternate" type="application/atom+xml" title="Blog Atom Feed" href="https://erlang.github.io/erlang-org/blog.xml" />
    
    <link rel="stylesheet" href="/erlang-org/assets/css/main.css">
</head>

<body>
    <header class="navbar navbar-expand-lg navbar-light bg-body">
        <nav class="container">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand" href="/erlang-org/"><img
                    src="/erlang-org/assets/img/erlang.png" class="img-fluid" width="60" alt="Erlang.org main page"/></a>
            <div class="collapse navbar-collapse fw-bold" id="navbarSupportedContent">
                <ul class="navbar-nav text-uppercase me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/downloads">Download</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/docs">Documentation</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/community">Community</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/news">News</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/blog">Blog</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/eep">EEP</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/about">About</a></li>
                </ul>
                <form class="d-flex" role="search" method="post" action="https://duckduckgo.com/?kg=p"
                    onsubmit="document.getElementById('searchq').value = document.getElementById('searchfield').value + ' site:erlang.org'; return true;">
                    <input type="hidden" id="searchq" name="q" class="hidden" />
                    <input class="form-control me-2" id="searchfield" type="search" placeholder="Search erlang.org"
                        aria-label="Search">
                    <button class="btn btn-outline-primary" type="submit">Search</button>
                </form>
            </div>
        </nav>
    </header>
    <div class="container border-top pt-4">
    <div class="row-lg">
        <div class="col-lg-10 offset-lg-1">
            <div class="card">
                <div class="card-body">
                    <dl class="mb-0 dl-single">
                        <dt>Author:</dt>
                        <dd>
                            Richard A. O&#39;Keefe &lt;ok(at)cs(dot)otago(dot)ac(dot)nz&gt;
                            
                            
                        </dd>
                        
                        <dt>Status:</dt>
                        <dd>Draft </dd>
                        <dt>Type:</dt>
                        <dd>Standards Track</dd>
                        
                        
                        <dt>Created:</dt>
                        <dd>07-Feb-2013</dd>
                        
                        <dt>Erlang-Version:</dt>
                        <dd>R16A</dd>
                        
                        
                        
                        
                    </dl>
                </div>
            </div>
            <div class="border-top mt-4">
                <h2 id="eep-42-setrlimit2-analogue-for-erlang">EEP 42: setrlimit(2) analogue for Erlang</h2>

<h1 id="abstract">Abstract</h1>

<p>A new function <code class="language-plaintext highlighter-rouge">erlang:set_process_info_limit/2</code> is added,
allowing a process to set limits on its own memory use.</p>

<h1 id="specification">Specification</h1>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">erlang</span><span class="p">:</span><span class="nf">set_process_info_limit</span><span class="p">(</span><span class="nv">Item</span><span class="p">,</span> <span class="nv">Limit</span> <span class="p">::</span> <span class="nf">integer</span><span class="p">())</span> <span class="o">-&gt;</span>
    <span class="nv">Old_Limit</span> <span class="p">::</span> <span class="nf">integer</span><span class="p">()</span>
</code></pre></div></div>

<p>An <code class="language-plaintext highlighter-rouge">Old_Limit</code> of 0 means that no limit has been set.
A Limit of 0 means that no limit is to be set.</p>

<p>The Items that can be set are</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">memory</code>, the number of bytes that may be used for stack, heap, and
internal structures.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">memory_words</code>, the same value as <code class="language-plaintext highlighter-rouge">memory</code>, but expressed in
words to be consistent with <code class="language-plaintext highlighter-rouge">heap_size</code>, <code class="language-plaintext highlighter-rouge">total_heap_size</code>, and
<code class="language-plaintext highlighter-rouge">stack_size</code> in <code class="language-plaintext highlighter-rouge">erlang:process_info/[1,2]</code>.  Those functions should
also be revised to accept this Item.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">message_queue_len</code>, the number of unprocessed messages.
(Aside.) The documentation refers to <code class="language-plaintext highlighter-rouge">message_queue_len</code>
but the system generates and recognises <code class="language-plaintext highlighter-rouge">message_queue_len</code>.
(End aside.)</p>
  </li>
</ul>

<p>The values that are actually set may be less than Limit as
long as any physically realisable system in the node as
configured cannot exceed the value used.</p>

<p>A non-zero memory limit is checked after each garbage
collection or other memory restructuring; setting the memory
limit to a non-zero value less than the current
<code class="language-plaintext highlighter-rouge">process_info(self(), 'memory')</code> forces an immediate garbage
collection.</p>

<p>If the memory required by a process exceeds its limit, the
process is exited with reason <code class="language-plaintext highlighter-rouge">memory</code>.</p>

<p>A non-zero message queue length limit is checked whenever
the message queue length is about to be incremented, or
when such a limit is set.</p>

<p>If the message queue length limit is exceeded, the process
is exited with reason <code class="language-plaintext highlighter-rouge">message_queue_len</code>.</p>

<h1 id="motivation">Motivation</h1>

<p>It is currently possible for an Erlang process to grab
memory without limit and eventually take down the whole
node.  This problem is frequently reported in the Erlang
mailing list.</p>

<p>It is also possible for the message queue of an Erlang
process to grow without limit.  This problem too is
reported often enough to be recognised.</p>

<p>This is an EEP rather than a library change request because
it requires low level runtime system changes to support it.
For example, the limits have to be <em>stored</em> somewhere,
suggesting a change in the data structure holding information
about a process.  The limits have to be <em>checked</em>, meaning
that changes to the garbage collector and the message sending
core are required.  The limits have to be <em>enforced</em>,
meaning that two new exit reasons have to be supported.  And
the new exit reasons and the new function have to be
<em>documented</em>, requiring changes to more than one document.</p>

<p>The need is long-standing, and at least the presence of this
EEP may provoke discussion leading to <em>some</em> resolution.</p>

<h1 id="rationale">Rationale</h1>

<p>The function that sets a limit should have a name based
in the name of the function that reports current use.
That function is <code class="language-plaintext highlighter-rouge">process_info</code>, hence the name I’ve
chosen here is <code class="language-plaintext highlighter-rouge">set_process_info_limit</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">erlang:process_info/[1,2]</code> functions can report on
any Erlang process.  But it is clearly dangerous to let
a process set another process’s limits.  All we actually
<em>need</em> is for a process to be able to set its own limits
in a startup phase.  That could be done by adding
<code class="language-plaintext highlighter-rouge">{'memory',Size}</code> and <code class="language-plaintext highlighter-rouge">{'message_queue_len',Count}</code> options
to <code class="language-plaintext highlighter-rouge">spawn_opt/[2,3]</code>.  However,</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">spawn_opt</span><span class="p">(</span><span class="nv">Fun</span><span class="p">,</span> <span class="p">[{</span><span class="nb">memory</span><span class="p">,</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">}])</span>
</code></pre></div></div>

<p>can be mimicked by</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nn">erlang</span><span class="p">:</span><span class="nf">set_process_info_limit</span><span class="p">(</span><span class="nb">memory</span><span class="p">,</span> <span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
    <span class="nv">Fun</span><span class="p">()</span>
<span class="k">end</span><span class="p">)</span>
</code></pre></div></div>

<p>and <code class="language-plaintext highlighter-rouge">set_process_info_limit/2</code> allows a process to set
different limits at different times.  If you are trying
to protect the system from <em>malice</em>, setting limits in
<code class="language-plaintext highlighter-rouge">spawn_opt/[2,3]</code> is the way to go.  If you are trying to
protect the system from <em>accident</em>, letting a process
set its own limits is the way to go.</p>

<p>The names for the Items to be set clearly must be identical
to the names used for the same thing elsewhere.</p>

<p>The <code class="language-plaintext highlighter-rouge">memory_words</code> item is introduced because in a world where
some of my programs run 32-bit and some run 64-bit it is just
too confusing to count bytes, especially as stack size and so
on are measured in words, not bytes.</p>

<p>I considered allowing <code class="language-plaintext highlighter-rouge">total_heap_size</code> and <code class="language-plaintext highlighter-rouge">stack_size</code> and so on
to be given their own limits, but on finding that <code class="language-plaintext highlighter-rouge">total_heap_size</code>
“currently includes the stack of the process”, decided that it
was “currently” a bad idea.</p>

<p>I would have liked to allow setting a limit on the number
of reductions, so that a process that doesn’t intend to
live forever can ensure its own eventual death.  However,
the documentation warns that <code class="language-plaintext highlighter-rouge">erlang:bump_reductions/1</code>
“might be removed”, so presumably reduction counting
<em>per se</em> might well disappear.</p>

<p>The point of letting the value actually set for a limit
to be smaller is to allow an implementation to use only
values that will fit in a <code class="language-plaintext highlighter-rouge">size_t</code>, so that low level
code does not need to deal with bignums.  On a
POSIX-compliant operating system, an Erlang implementation
may use the <code class="language-plaintext highlighter-rouge">RLIMIT_DATA</code> value for the UNIX process
if the memory limit is bigger, and may use <code class="language-plaintext highlighter-rouge">RLIMIT_DATA</code>
divided by the minimum size of a message for the message
queue length.  Or it might use other appropriate system
limits.</p>

<p>The biggest question is “what happens if a limit is exceeded?”</p>

<p>For memory, we could exit with <code class="language-plaintext highlighter-rouge">system_limit</code> as reason, but
that wouldn’t make clear <em>what</em> limit had been exceeded.  It
seems advisable to introduce a new reason, and making the
reason the same as the name of the limit seems the least
confusing approach.</p>

<p>For message queue length, I would prefer it if the process
that <em>sends</em> the message were the one to get a run time error.
However, the Erlang documentation guarantees that sending a
message to a pid always succeeds, whether the process is live
or dead, and I don’t want to change too much.  A message queue
might build up because some process(es) is(are) sending junk;
we would prefer exiting junk senders to exiting junk receivers.
However, if the junk receiver isn’t cleaning out the junk, that
junk is <em>never</em> going away, so it’s <em>always</em> going to be costing
time to skip over as well as memory to store.  That argument
applies to another option that I considered: just discarding
messages that would make the queue too long.  The Erlang Way is
to let subsystems that get into trouble crash.  So let it be.</p>

<h1 id="backwards-compatibility">Backwards Compatibility</h1>

<p>The new function is not exported by default
so it cannot be called accidentally.</p>

<h1 id="reference-implementation">Reference Implementation</h1>

<p>None in this draft.</p>

<h1 id="copyright">Copyright</h1>

<p>This document has been placed in the public domain.</p>


            </div>
        </div>
    </div>
</div>
<script src="/erlang-org/assets/js/prismjs/prism.js"></script>
<script src="/erlang-org/assets/js/prismjs/components/prism-erlang.js"></script>
    <footer class="container-fluid footer text-center border-top border-bottom">
        <div>
            <a href="/erlang-org/downloads.html" title="DOWNLOAD"><img src="/erlang-org/assets/img/download.png"></a>
        </div>
        <div>
            <a href="http://www.github.com/erlang/otp"><img
                    src="/erlang-org/assets/img/GitHub-Mark-32px.png"></a>
        </div>
        
        <div>
            <a href="http://www.twitter.com/erlang_org"><img src="/erlang-org/assets/img/twitter.png"
                    width="32"></a>
        </div>
    </footer>
    <script src="/erlang-org/assets/js/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>