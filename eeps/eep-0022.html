<!DOCTYPE html>
<html lang="en">



<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Allow pinning of website on windows -->
    <meta name="application-name" content="Erlang.org">
    <meta name="msapplication-tooltip" content="The official home of the Erlang Programming Language">
    <meta name="msapplication-starturl" content="/erlang-org/" >

    <!-- Make the site look nicer on facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Erlang.org">
    <meta property="og:title" content="Welcome to Erlang.org">
    <meta property="og:description" content="The official home of the Erlang Programming Language">
    <meta property="og:image" content="https://erlang.github.io/erlang-org/assets/img/erlang-228x200.png">
    <meta property="og:image:secure_url" content="https://erlang.github.io/erlang-org/assets/img/erlang-228x200.png">
    <meta property="og:url" content="https://erlang.github.io/erlang-org/">

    <!-- Twitter metadata -->
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="Index" />
    <meta name="twitter:site" content="@erlang_org" />

    <!-- Rich data for google search -->
    <script type="application/ld+json">
{"@type":"WebSite","url":"https://erlang.org/","headline":"Eep 0022 - Erlang/OTP","name":"Erlang.org","sameAs":["https://twitter.com/erlang_org","https://github.com/erlang/otp"],"@context":"https://schema.org"}</script>

    <title>Eep 0022 - Erlang/OTP</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- tells iOS browsers to not show telephone numbers as links -->
    <meta name="format-detection" content="telephone=no">

    <meta name="application-name" content="Erlang.org">
    <meta name="description" content="The official home of the Erlang Programming Language">
    <meta name="keywords" content="Erlang programming language functional parallel distributed documentation download community">
    <!-- https://www.rssboard.org/rss-autodiscovery -->
    <link rel="alternate" type="application/atom+xml" title="News Atom Feed" href="https://erlang.github.io/erlang-org/news.xml" />
    <link rel="alternate" type="application/atom+xml" title="Blog Atom Feed" href="https://erlang.github.io/erlang-org/blog.xml" />
    
    <link rel="stylesheet" href="/erlang-org/assets/css/main.css">
</head>

<body>
    <header class="navbar navbar-expand-lg navbar-light bg-body">
        <nav class="container">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand" href="/erlang-org/"><img
                    src="/erlang-org/assets/img/erlang.png" class="img-fluid" width="60" alt="Erlang.org main page"/></a>
            <div class="collapse navbar-collapse fw-bold" id="navbarSupportedContent">
                <ul class="navbar-nav text-uppercase me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/downloads">Download</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/docs">Documentation</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/community">Community</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/news">News</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/blog">Blog</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/eep">EEP</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/about">About</a></li>
                </ul>
                <form class="d-flex" role="search" method="post" action="https://duckduckgo.com/?kg=p"
                    onsubmit="document.getElementById('searchq').value = document.getElementById('searchfield').value + ' site:erlang.org'; return true;">
                    <input type="hidden" id="searchq" name="q" class="hidden" />
                    <input class="form-control me-2" id="searchfield" type="search" placeholder="Search erlang.org"
                        aria-label="Search">
                    <button class="btn btn-outline-primary" type="submit">Search</button>
                </form>
            </div>
        </nav>
    </header>
    <div class="container border-top pt-4">
    <div class="row-lg">
        <div class="col-lg-10 offset-lg-1">
            <div class="card">
                <div class="card-body">
                    <dl class="mb-0 dl-single">
                        <dt>Author:</dt>
                        <dd>
                            Richard A. O&#39;Keefe &lt;ok(at)cs(dot)otago(dot)ac(dot)nz&gt;
                            
                            
                        </dd>
                        
                        <dt>Status:</dt>
                        <dd>Draft </dd>
                        <dt>Type:</dt>
                        <dd>Standards Track</dd>
                        
                        
                        <dt>Created:</dt>
                        <dd>27-Aug-2008</dd>
                        
                        <dt>Erlang-Version:</dt>
                        <dd>R12B-4</dd>
                        
                        
                        
                        
                    </dl>
                </div>
            </div>
            <div class="border-top mt-4">
                <h2 id="eep-22-range-checking-for-binaries">EEP 22: Range checking for binaries</h2>

<h1 id="abstract">Abstract</h1>

<p>A module may request that bit fields be range checked.</p>

<h1 id="specification">Specification</h1>

<p>A new directive is added.</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">bit_range_check</span><span class="p">(</span><span class="nv">Wanted</span><span class="p">).</span>
</code></pre></div></div>

<p>where Wanted is ‘false’ or ‘true’.</p>

<p>Recall that a segment of a bit string (or binary) has the form</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Value</span> <span class="p">[</span><span class="n">':'</span> <span class="nv">Size</span><span class="p">]</span> <span class="p">[</span><span class="n">'/'</span> <span class="nv">Type_Specifier_List</span><span class="p">]</span>
</code></pre></div></div>

<p>where <code class="language-plaintext highlighter-rouge">Type_Specifier_List</code> includes such things as ‘integer’,
‘signed’, and ‘unsigned’.  Currently the documentation states
that</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">"Signedness ... Only matters for matching and when the type
 is integer.  The default is unsigned."</span>
</code></pre></div></div>

<p>Combining the <code class="language-plaintext highlighter-rouge">Size</code> with the <code class="language-plaintext highlighter-rouge">Unit</code> gives a <code class="language-plaintext highlighter-rouge">Size_In_Bits</code>.
The on-line Erlang manual does not state in section 6.16 that
in constructing a bit string the bottom <code class="language-plaintext highlighter-rouge">Size_In_Bits</code> bits of
an integer are used with the rest quietly ignored, but it is so.</p>

<p>The directive <code class="language-plaintext highlighter-rouge">-bit_range_check(false)</code> makes explicit the
programmer’s intention that this C-like truncation should happen.</p>

<p>The directive <code class="language-plaintext highlighter-rouge">-bit_range_check(true)</code> says that it is a checked
run-time error in</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Value</span><span class="p">:</span><span class="nv">Size</span><span class="o">/</span><span class="n">unsigned</span><span class="o">-</span><span class="n">integer</span><span class="o">-</span><span class="nn">unit</span><span class="p">:</span><span class="mi">1</span>
</code></pre></div></div>

<p>or constructions otherwise equivalent to it if Value does not
lie in the range <code class="language-plaintext highlighter-rouge">0 &lt;= Value &lt; 2**Size</code>, and it is a checked
run-time error in</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Value</span><span class="p">:</span><span class="nv">Size</span><span class="o">/</span><span class="n">signed</span><span class="o">-</span><span class="n">integer</span><span class="o">-</span><span class="nn">unit</span><span class="p">:</span><span class="mi">1</span>
</code></pre></div></div>

<p>or constructions otherwise equivalent to it if Value does not
lie in the range <code class="language-plaintext highlighter-rouge">-(2**(Size-1)) &lt;= Value &lt; 2**(Size-1)</code>.</p>

<p>The error that is raised is like the error that would be raised
for <code class="language-plaintext highlighter-rouge">(1//0):Size/Type_Specifier_List</code> except for using ‘badrange’
instead of ‘badarith’.</p>

<p>The behaviour of integer bit syntax segments in the absence of
a <code class="language-plaintext highlighter-rouge">-bit_range_check</code> directive is implementation defined and
subject to change.</p>

<p>The BEAM system is extended with a new instruction or instructions
similar to the existing instruction or instructions for integer
segments but checking the range.  The compiler is extended to
generate them for <code class="language-plaintext highlighter-rouge">&lt;&lt;...&gt;&gt;</code> expressions in the range of a
<code class="language-plaintext highlighter-rouge">-bit_range_check(true)</code> directive.</p>

<p>A <code class="language-plaintext highlighter-rouge">-bit_range_check</code> directive may not appear after a bit syntax
pattern or expression or after another <code class="language-plaintext highlighter-rouge">-bit_range_check</code> directive.</p>

<h1 id="motivation">Motivation</h1>

<p>It keeps on coming as an unpleasant surprise to Erlang programmers
that this truncation happens.  Quiet destruction of information is
otherwise alien to Erlang:  integer arithmetic is unbounded, not
wrapped as in some (but not all) C systems; element/2 doesn’t take
indices modulo tuple size but raises an exception if the index is
out of range, and so on.</p>

<p>In any case where the truncation is wanted, an Erlang programmer
can already write</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nv">Value</span> <span class="ow">rem</span> <span class="mi">256</span><span class="p">):</span><span class="n">unsigned</span><span class="o">-</span><span class="n">integer</span>
</code></pre></div></div>

<p>and the Erlang compiler could notice this and optimise the ‘rem’
operation away, so the truncation is not only unusual in Erlang,
it is also unexpected in this particular case.</p>

<p>It is not only unexpected, it removes a chance to find mistakes,
so it would seem to be undesirable.</p>

<p>Edwin Fine asked “How difficult could it be to add optional run-
time checking to detect this condition without a serious risk of
adverse effects on the correctness of Erlang run-time execution?”</p>

<p>Björn Gustavsson replied “it would be better to add optional
support in the compiler to turn on checks (either for an entire
module, or for individual segments of a binary).  If someone
writes an EEP, we will consider implementing it.”</p>

<p>This is that EEP.</p>

<h1 id="rationale">Rationale</h1>

<p>The Erlang/OTP team regard the old behaviour as a feature,
and wish to retain it.  In particular, they wish modules that
were written expecting the old behaviour to continue to work
(for now) without modification.</p>

<p>One alternative would be to add new syntax, such as having a
new ‘checked’ specifier, so that</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Value</span><span class="o">/</span><span class="n">checked</span><span class="o">-</span><span class="n">unsigned</span><span class="o">-</span><span class="n">integer</span>
</code></pre></div></div>

<p>would require a value in the range 0..255.
But many Erlang programmers will want to use this as the normal
case, and will not like the safe version being so much more effort
to write than the unsafe version.</p>

<p>It appears that “truncation wanted/not wanted” is not a matter
of this expression or that, but of this programmer or that,
and we can expect that each module will be written by someone
expecting only one behaviour or expecting only the other.</p>

<p>Adding a</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">bit_range_check</span><span class="p">(</span><span class="n">true</span><span class="p">).</span>
</code></pre></div></div>

<p>directive to a module is more work than doing nothing at all,
but programmers who want this behaviour should be able to set up
their editing environment to have this line in their template for
creating new Erlang modules.</p>

<p>There are several questions:</p>

<ul>
  <li>Should this apply to bit strings as well as integers?</li>
  <li>What should the name of the directive be?</li>
  <li>What should the argument(s) of the directive be?</li>
  <li>Should multiple instances of the directive be allowed in
a module?</li>
</ul>

<p>Bit strings:  <code class="language-plaintext highlighter-rouge">Assume X = &lt;&lt;5:3/unsigned-integer-unit:1&gt;&gt;</code>.
Currently, <code class="language-plaintext highlighter-rouge">&lt;&lt;X:2/bits&gt;&gt;</code> quietly truncates <code class="language-plaintext highlighter-rouge">X</code>.  This drops bits
from the right of <code class="language-plaintext highlighter-rouge">X</code>, giving <code class="language-plaintext highlighter-rouge">&lt;&lt;2:2&gt;&gt;</code>.  If this worked the same
as integers, you would expect <code class="language-plaintext highlighter-rouge">&lt;&lt;1:2&gt;&gt;</code>.  This is certainly
very odd.  Since we get truncation on the left and padding on
the left for integers, we naturally expect padding on the
right for bit strings to go with truncation on the right.
But <code class="language-plaintext highlighter-rouge">&lt;&lt;X:4/bits&gt;&gt;</code> isn’t <code class="language-plaintext highlighter-rouge">&lt;&lt;10:4&gt;&gt;</code>, it’s a runtime exception.
All very odd indeed.  It would certainly be desirable to have
an easy way for the programmer to indicate whether they wanted
truncation on the left or the right and padding on the left or
the right.  Perhaps a new built in function</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">set_bit_size</span><span class="p">(</span><span class="nv">Bit_String</span><span class="p">,</span> <span class="nv">Desired_Width</span><span class="p">,</span>
             <span class="nv">Truncation</span><span class="p">,</span> <span class="nv">Padding</span><span class="p">,</span> <span class="nv">Fill</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Bit_String</span> <span class="p">:</span> <span class="n">a</span> <span class="n">bit</span> <span class="n">string</span>
<span class="nv">Desired_Width</span> <span class="p">:</span> <span class="n">a</span> <span class="n">non</span><span class="o">-</span><span class="n">negative</span> <span class="n">integer</span><span class="p">,</span> <span class="n">the</span> <span class="n">width</span> <span class="n">wanted</span>
<span class="nv">Truncation</span><span class="p">:</span> <span class="n">'left'</span> <span class="p">|</span> <span class="n">'right'</span> <span class="p">|</span> <span class="n">'error'</span><span class="p">;</span>
    <span class="k">if</span> <span class="nb">bit_size</span><span class="p">(</span><span class="nv">Bit_String</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nv">Desired_Width</span>
        <span class="n">truncate</span> <span class="n">on</span> <span class="n">the</span> <span class="n">left</span><span class="o">/</span><span class="n">truncate</span> <span class="n">on</span> <span class="n">the</span> <span class="n">right</span><span class="o">/</span>
        <span class="n">report</span> <span class="n">an</span> <span class="n">error</span>
<span class="nv">Padding</span><span class="p">:</span> <span class="n">'left'</span> <span class="p">|</span> <span class="n">'right'</span> <span class="p">|</span> <span class="n">'error'</span><span class="p">;</span>
    <span class="k">if</span> <span class="nb">bit_size</span><span class="p">(</span><span class="nv">Bit_String</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nv">Desired_Width</span>
        <span class="n">pad</span> <span class="n">on</span> <span class="n">the</span> <span class="n">left</span><span class="o">/</span><span class="n">pad</span> <span class="n">on</span> <span class="n">the</span> <span class="n">right</span><span class="o">/</span><span class="n">report</span> <span class="n">an</span> <span class="n">error</span>
<span class="nv">Fill</span><span class="p">:</span> <span class="mi">0</span> <span class="p">|</span> <span class="mi">1</span> <span class="p">|</span> <span class="n">'copy'</span><span class="p">;</span>
    <span class="n">pad</span> <span class="n">with</span> <span class="mi">0</span><span class="o">/</span><span class="n">pad</span> <span class="n">with</span> <span class="mi">1</span><span class="o">/</span><span class="n">pad</span> <span class="n">with</span> <span class="n">a</span> <span class="n">copy</span> <span class="k">of</span> <span class="n">the</span>
    <span class="n">last</span> <span class="n">bit</span> <span class="n">at</span> <span class="n">the</span> <span class="k">end</span> <span class="n">where</span> <span class="n">padding</span> <span class="n">is</span> <span class="n">done</span><span class="p">.</span>
</code></pre></div></div>

<p>However, that idea is only partly baked, and is not part of the
current proposal.  As things currently stand, using the bit
syntax and relying on implicit truncation is the simplest way
to extract the leading bits of a bit string.</p>

<p>As long as the name of the directive is intention-revealing,
it doesn’t matter very much what it is.
I proposed <code class="language-plaintext highlighter-rouge">bit_range_check</code> because it is all about checking,
ranges in bit syntax, but since in this draft it does NOT apply
to bit string segments, perhaps <code class="language-plaintext highlighter-rouge">bit_integer_range_check</code> would
be better.</p>

<p>The arguments false and true seem clear enough.
Alternatives would be something like</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">bit_integer_range</span><span class="p">(</span><span class="n">check</span><span class="p">).</span>
<span class="p">-</span><span class="ni">bit_integer_range</span><span class="p">(</span><span class="n">no_check</span><span class="p">).</span>
</code></pre></div></div>

<p>That would be fine too.</p>

<p>Classical Pascal compilers let you do things like</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="sc">$I</span><span class="o">-</span><span class="p">}</span>   <span class="p">(</span><span class="o">*</span> <span class="n">disable</span> <span class="n">index</span> <span class="n">checks</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">code</span> <span class="n">with</span> <span class="n">no</span> <span class="n">index</span> <span class="n">checks</span> <span class="o">*</span><span class="p">)</span>
<span class="p">{</span><span class="sc">$I</span><span class="o">+</span><span class="p">}</span>   <span class="p">(</span><span class="o">*</span> <span class="n">re</span><span class="o">-</span><span class="n">enable</span> <span class="n">index</span> <span class="n">checks</span> <span class="o">*</span><span class="p">)</span>
</code></pre></div></div>

<p>Allowing multiple <code class="language-plaintext highlighter-rouge">-bit_range_check</code> directives in a module could
let you use code written for the old approach inside a module
that otherwise uses the new approach.  I don’t believe that we
want to encourage that sort of thing:  it is MUCH easier when
reading a module if all of it follows the same rule.</p>

<p>It is also easier for an Erlang compiler that expects to be able
to process function definitions in any order.  The compiler can
check for one of these directives anywhere in a module before it
handles any bit syntax forms anywhere.  However, it is easier for
people reading a module if, when they first see a <code class="language-plaintext highlighter-rouge">&lt;&lt;...&gt;&gt;</code>
construction, they have already seen any directive that might
affect what it means.</p>

<p>The restrictions on the number and placement of these directives
can always be relaxed later if necessary.</p>

<h1 id="backwards-compatibility">Backwards Compatibility</h1>

<p>All existing Erlang code remains acceptable with unchanged semantics.</p>

<h1 id="reference-implementation">Reference Implementation</h1>

<p>None, because I still can’t find my way around the compiler.</p>

<h1 id="copyright">Copyright</h1>

<p>This document has been placed in the public domain.</p>


            </div>
        </div>
    </div>
</div>
<script src="/erlang-org/assets/js/prismjs/prism.js"></script>
<script src="/erlang-org/assets/js/prismjs/components/prism-erlang.js"></script>
    <footer class="container-fluid footer text-center border-top border-bottom">
        <div>
            <a href="/erlang-org/downloads.html" title="DOWNLOAD"><img src="/erlang-org/assets/img/download.png"></a>
        </div>
        <div>
            <a href="http://www.github.com/erlang/otp"><img
                    src="/erlang-org/assets/img/GitHub-Mark-32px.png"></a>
        </div>
        
        <div>
            <a href="http://www.twitter.com/erlang_org"><img src="/erlang-org/assets/img/twitter.png"
                    width="32"></a>
        </div>
    </footer>
    <script src="/erlang-org/assets/js/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>