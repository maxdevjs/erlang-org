<!DOCTYPE html>
<html lang="en">



<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Allow pinning of website on windows -->
    <meta name="application-name" content="Erlang.org">
    <meta name="msapplication-tooltip" content="The official home of the Erlang Programming Language">
    <meta name="msapplication-starturl" content="/erlang-org/" >

    <!-- Make the site look nicer on facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Erlang.org">
    <meta property="og:title" content="Welcome to Erlang.org">
    <meta property="og:description" content="The official home of the Erlang Programming Language">
    <meta property="og:image" content="https://erlang.github.io/erlang-org/assets/img/erlang-228x200.png">
    <meta property="og:image:secure_url" content="https://erlang.github.io/erlang-org/assets/img/erlang-228x200.png">
    <meta property="og:url" content="https://erlang.github.io/erlang-org/">

    <!-- Twitter metadata -->
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="Index" />
    <meta name="twitter:site" content="@erlang_org" />

    <!-- Rich data for google search -->
    <script type="application/ld+json">
{"@type":"WebSite","url":"https://erlang.org/","headline":"Eep 0036 - Erlang/OTP","name":"Erlang.org","sameAs":["https://twitter.com/erlang_org","https://github.com/erlang/otp"],"@context":"https://schema.org"}</script>

    <title>Eep 0036 - Erlang/OTP</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- tells iOS browsers to not show telephone numbers as links -->
    <meta name="format-detection" content="telephone=no">

    <meta name="application-name" content="Erlang.org">
    <meta name="description" content="The official home of the Erlang Programming Language">
    <meta name="keywords" content="Erlang programming language functional parallel distributed documentation download community">
    <!-- https://www.rssboard.org/rss-autodiscovery -->
    <link rel="alternate" type="application/atom+xml" title="News Atom Feed" href="https://erlang.github.io/erlang-org/news.xml" />
    <link rel="alternate" type="application/atom+xml" title="Blog Atom Feed" href="https://erlang.github.io/erlang-org/blog.xml" />
    
    <link rel="stylesheet" href="/erlang-org/assets/css/main.css">
</head>

<body>
    <header class="navbar navbar-expand-lg navbar-light bg-body">
        <nav class="container">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand" href="/erlang-org/"><img
                    src="/erlang-org/assets/img/erlang.png" class="img-fluid" width="60" alt="Erlang.org main page"/></a>
            <div class="collapse navbar-collapse fw-bold" id="navbarSupportedContent">
                <ul class="navbar-nav text-uppercase me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/downloads">Download</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/docs">Documentation</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/community">Community</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/news">News</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/blog">Blog</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/eep">EEP</a></li>
                    <li class="nav-item"><a class="nav-link" href="/erlang-org/about">About</a></li>
                </ul>
                <form class="d-flex" role="search" method="post" action="https://duckduckgo.com/?kg=p"
                    onsubmit="document.getElementById('searchq').value = document.getElementById('searchfield').value + ' site:erlang.org'; return true;">
                    <input type="hidden" id="searchq" name="q" class="hidden" />
                    <input class="form-control me-2" id="searchfield" type="search" placeholder="Search erlang.org"
                        aria-label="Search">
                    <button class="btn btn-outline-primary" type="submit">Search</button>
                </form>
            </div>
        </nav>
    </header>
    <div class="container border-top pt-4">
    <div class="row-lg">
        <div class="col-lg-10 offset-lg-1">
            <div class="card">
                <div class="card-body">
                    <dl class="mb-0 dl-single">
                        <dt>Author:</dt>
                        <dd>
                            Björn Gustavsson &lt;bjorn(at)erlang(dot)org&gt;
                            
                            
                        </dd>
                        
                        <dt>Status:</dt>
                        <dd>Final/R15B Proposal is implemented in OTP release R15B</dd>
                        <dt>Type:</dt>
                        <dd>Standards Track</dd>
                        
                        
                        <dt>Created:</dt>
                        <dd>01-Mar-2011</dd>
                        
                        <dt>Erlang-Version:</dt>
                        <dd>R15A</dd>
                        
                        
                        
                        
                    </dl>
                </div>
            </div>
            <div class="border-top mt-4">
                <h2 id="eep-36-line-numbers-in-exceptions">EEP 36: Line numbers in exceptions</h2>

<h1 id="abstract">Abstract</h1>

<p>Extend each entry in the call stack backtrace (hereafter called
<strong>stacktrace</strong>) returned from the <code class="language-plaintext highlighter-rouge">erlang:get_stacktrace/0</code> BIF and from the
<code class="language-plaintext highlighter-rouge">catch</code> operator with filenames and line number information.</p>

<h1 id="specification">Specification</h1>

<p>Currently a stack trace returned from <code class="language-plaintext highlighter-rouge">erlang:get_stacktrace/0</code>
(and the <code class="language-plaintext highlighter-rouge">catch</code> operator) is a list of three-tuples, where
each tuple looks like:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nv">Module</span><span class="p">,</span><span class="nv">Function</span><span class="p">,</span><span class="nv">Arity</span><span class="p">}</span>
</code></pre></div></div>

<p>(In some cases, the third element may be a list of arguments instead
of the function arity.)</p>

<p>We propose to change each tuple to:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nv">Module</span><span class="p">,</span><span class="nv">Function</span><span class="p">,</span><span class="nv">Arity</span><span class="p">,</span><span class="nv">LocationInfo</span><span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">LocationInfo</code> is a property list (a list of two-tuples) that
contains filename and line number information. If there is
line number information available, the list will look like:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[{</span><span class="n">file</span><span class="p">,</span><span class="nv">FilenameString</span><span class="p">},{</span><span class="n">line</span><span class="p">,</span><span class="nv">LineNumber</span><span class="p">}]</span>
</code></pre></div></div>

<p>The list should be accessed using <code class="language-plaintext highlighter-rouge">proplists:get_value/3</code> or
<code class="language-plaintext highlighter-rouge">lists:keyfind/3</code>, not by direct matching, since a future release
may add more items to the list or change the order.</p>

<p>The filename is usually the same as the module with the extension
“.erl” added, but if function definitions have been placed in a header
file, the filename will be the name of the header file.  The filename
will also be different if the Erlang source file has been generated by
a code generator such as yecc.</p>

<p>The line number will never be zero; instead <code class="language-plaintext highlighter-rouge">LocationInfo</code> will be
set to an empty list.</p>

<p>The list will be empty if there is no location information available.
Here are some reasons that location information may be missing:</p>

<ul>
  <li>
    <p>The module has been compiled with an older BEAM compiler that does
not support generation of line number information.</p>
  </li>
  <li>
    <p>The module was created by calling <code class="language-plaintext highlighter-rouge">compile:forms/1,2</code> with forms
that did not contain non-zero line numbers and/or filenames.</p>
  </li>
  <li>
    <p>A parse transform created abstract forms having the line number zero.</p>
  </li>
  <li>
    <p>The module was created using an alternate compiler that did not
provide filenames and/or (non-zero) line numbers.</p>
  </li>
  <li>
    <p>The line number information may have been stripped from
the BEAM file.</p>
  </li>
  <li>
    <p>The exception occurs in a BIF (implemented in C in the run-time
system).</p>
  </li>
</ul>

<h2 id="implementation-requirements">Implementation requirements</h2>

<p>This EEP does not specify exactly how line number information should
be implemented, but it does impose some requirements on the
implementation:</p>

<ul>
  <li>
    <p>The presence of line number information should have (virtually) no
impact on the execution time for a program if no exceptions occur.  In
practice, that means that an implementation is <em>not</em> allowed to add
extra instructions or BIF calls that will be executed when no
exception occurs.</p>
  </li>
  <li>
    <p>Line number information should not be dependent on debug information
being present in the BEAM file.</p>
  </li>
  <li>
    <p>Line number information should be included by default in BEAM files.
(There could be options to turn off the inclusion of line number
information.)</p>
  </li>
  <li>
    <p>Loading line number information should be the default. There may be
an option to turn off loading of line number information in order to
save memory.</p>
  </li>
</ul>

<h2 id="example">Example</h2>

<p>In the examples, we will use the following module:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">example</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">m</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
<span class="p">-</span><span class="ni">include</span><span class="p">(</span><span class="s">"header.hrl"</span><span class="p">).</span>
</code></pre></div></div>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">m</span><span class="p">(</span><span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="nn">lists</span><span class="p">:</span><span class="nf">map</span><span class="p">(</span><span class="k">fun</span> <span class="n">f</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="nv">L</span><span class="p">)}.</span>  <span class="c">%Line 6
</span></code></pre></div></div>

<p>and the header file header.hrl:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">f</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nb">abs</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">.</span>        <span class="c">%Line 2
</span></code></pre></div></div>

<p>Using R14B01 to call our example module, we get the following
result:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">example</span><span class="p">:</span><span class="nf">m</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]).</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]}</span>
<span class="mi">2</span><span class="o">&gt;</span> <span class="nn">example</span><span class="p">:</span><span class="nf">m</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">not_a_number</span><span class="p">]).</span>
<span class="o">**</span> <span class="n">exception</span> <span class="nn">error</span><span class="p">:</span> <span class="n">bad</span> <span class="n">argument</span>
     <span class="n">in</span> <span class="n">function</span>  <span class="nb">abs</span><span class="o">/</span><span class="mi">1</span>
        <span class="n">called</span> <span class="n">as</span> <span class="nb">abs</span><span class="p">(</span><span class="n">not_a_number</span><span class="p">)</span>
     <span class="n">in</span> <span class="n">call</span> <span class="n">from</span> <span class="nn">example</span><span class="p">:</span><span class="n">f</span><span class="o">/</span><span class="mi">1</span>
     <span class="n">in</span> <span class="n">call</span> <span class="n">from</span> <span class="nn">lists</span><span class="p">:</span><span class="n">map</span><span class="o">/</span><span class="mi">2</span>
     <span class="n">in</span> <span class="n">call</span> <span class="n">from</span> <span class="nn">lists</span><span class="p">:</span><span class="n">map</span><span class="o">/</span><span class="mi">2</span>
     <span class="n">in</span> <span class="n">call</span> <span class="n">from</span> <span class="nn">example</span><span class="p">:</span><span class="n">m</span><span class="o">/</span><span class="mi">1</span>
<span class="mi">3</span><span class="o">&gt;</span> <span class="k">catch</span> <span class="nn">example</span><span class="p">:</span><span class="nf">m</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">not_a_number</span><span class="p">]).</span>
<span class="p">{</span><span class="n">'EXIT'</span><span class="p">,{</span><span class="n">badarg</span><span class="p">,[{</span><span class="n">erlang</span><span class="p">,</span><span class="nb">abs</span><span class="p">,[</span><span class="n">not_a_number</span><span class="p">]},</span>
                 <span class="p">{</span><span class="n">example</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span>
                 <span class="p">{</span><span class="n">lists</span><span class="p">,</span><span class="n">map</span><span class="p">,</span><span class="mi">2</span><span class="p">},</span>
                 <span class="p">{</span><span class="n">lists</span><span class="p">,</span><span class="n">map</span><span class="p">,</span><span class="mi">2</span><span class="p">},</span>
                 <span class="p">{</span><span class="n">example</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span>
                 <span class="p">{</span><span class="n">erl_eval</span><span class="p">,</span><span class="n">do_apply</span><span class="p">,</span><span class="mi">5</span><span class="p">},</span>
                 <span class="p">{</span><span class="n">erl_eval</span><span class="p">,</span><span class="n">expr</span><span class="p">,</span><span class="mi">5</span><span class="p">},</span>
                 <span class="p">{</span><span class="n">shell</span><span class="p">,</span><span class="n">exprs</span><span class="p">,</span><span class="mi">7</span><span class="p">}]}}</span>
</code></pre></div></div>

<p>In a system with line number information enabled, we get:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">example</span><span class="p">:</span><span class="nf">m</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]).</span>             
<span class="p">{</span><span class="n">ok</span><span class="p">,[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]}</span>
<span class="mi">2</span><span class="o">&gt;</span> <span class="nn">example</span><span class="p">:</span><span class="nf">m</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">not_a_number</span><span class="p">]).</span>
<span class="o">**</span> <span class="n">exception</span> <span class="nn">error</span><span class="p">:</span> <span class="n">bad</span> <span class="n">argument</span>
     <span class="n">in</span> <span class="n">function</span>  <span class="nb">abs</span><span class="o">/</span><span class="mi">1</span>
        <span class="n">called</span> <span class="n">as</span> <span class="nb">abs</span><span class="p">(</span><span class="n">not_a_number</span><span class="p">)</span>
     <span class="n">in</span> <span class="n">call</span> <span class="n">from</span> <span class="nn">example</span><span class="p">:</span><span class="n">f</span><span class="o">/</span><span class="mi">1</span> <span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">hrl</span><span class="p">,</span> <span class="n">line</span> <span class="mi">2</span><span class="p">)</span>
     <span class="n">in</span> <span class="n">call</span> <span class="n">from</span> <span class="nn">lists</span><span class="p">:</span><span class="n">map</span><span class="o">/</span><span class="mi">2</span> <span class="p">(</span><span class="n">lists</span><span class="p">.</span><span class="n">erl</span><span class="p">,</span> <span class="n">line</span> <span class="mi">948</span><span class="p">)</span>
     <span class="n">in</span> <span class="n">call</span> <span class="n">from</span> <span class="nn">lists</span><span class="p">:</span><span class="n">map</span><span class="o">/</span><span class="mi">2</span> <span class="p">(</span><span class="n">lists</span><span class="p">.</span><span class="n">erl</span><span class="p">,</span> <span class="n">line</span> <span class="mi">948</span><span class="p">)</span>
     <span class="n">in</span> <span class="n">call</span> <span class="n">from</span> <span class="nn">example</span><span class="p">:</span><span class="n">m</span><span class="o">/</span><span class="mi">1</span> <span class="p">(</span><span class="n">example</span><span class="p">.</span><span class="n">erl</span><span class="p">,</span> <span class="n">line</span> <span class="mi">6</span><span class="p">)</span>
<span class="mi">3</span><span class="o">&gt;</span> <span class="k">catch</span> <span class="nn">example</span><span class="p">:</span><span class="nf">m</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">not_a_number</span><span class="p">]).</span>
<span class="p">{</span><span class="n">'EXIT'</span><span class="p">,{</span><span class="n">badarg</span><span class="p">,[{</span><span class="n">erlang</span><span class="p">,</span><span class="nb">abs</span><span class="p">,[</span><span class="n">not_a_number</span><span class="p">],[]},</span>
                 <span class="p">{</span><span class="n">example</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">,[{</span><span class="n">file</span><span class="p">,</span><span class="s">"header.hrl"</span><span class="p">},{</span><span class="n">line</span><span class="p">,</span><span class="mi">2</span><span class="p">}]},</span>
                 <span class="p">{</span><span class="n">lists</span><span class="p">,</span><span class="n">map</span><span class="p">,</span><span class="mi">2</span><span class="p">,[{</span><span class="n">file</span><span class="p">,</span><span class="s">"lists.erl"</span><span class="p">},{</span><span class="n">line</span><span class="p">,</span><span class="mi">948</span><span class="p">}]},</span>
                 <span class="p">{</span><span class="n">lists</span><span class="p">,</span><span class="n">map</span><span class="p">,</span><span class="mi">2</span><span class="p">,[{</span><span class="n">file</span><span class="p">,</span><span class="s">"lists.erl"</span><span class="p">},{</span><span class="n">line</span><span class="p">,</span><span class="mi">948</span><span class="p">}]},</span>
                 <span class="p">{</span><span class="n">example</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">,[{</span><span class="n">file</span><span class="p">,</span><span class="s">"example.erl"</span><span class="p">},{</span><span class="n">line</span><span class="p">,</span><span class="mi">6</span><span class="p">}]},</span>
                 <span class="p">{</span><span class="n">erl_eval</span><span class="p">,</span><span class="n">do_apply</span><span class="p">,</span><span class="mi">5</span><span class="p">,[{</span><span class="n">file</span><span class="p">,</span><span class="s">"erl_eval.erl"</span><span class="p">},{</span><span class="n">line</span><span class="p">,</span><span class="mi">482</span><span class="p">}]},</span>
                 <span class="p">{</span><span class="n">erl_eval</span><span class="p">,</span><span class="n">expr</span><span class="p">,</span><span class="mi">5</span><span class="p">,[{</span><span class="n">file</span><span class="p">,</span><span class="s">"erl_eval.erl"</span><span class="p">},{</span><span class="n">line</span><span class="p">,</span><span class="mi">276</span><span class="p">}]},</span>
                 <span class="p">{</span><span class="n">shell</span><span class="p">,</span><span class="n">exprs</span><span class="p">,</span><span class="mi">7</span><span class="p">,[{</span><span class="n">file</span><span class="p">,</span><span class="s">"shell.erl"</span><span class="p">},{</span><span class="n">line</span><span class="p">,</span><span class="mi">666</span><span class="p">}]}]}}</span>
</code></pre></div></div>

<p>If we compile the <code class="language-plaintext highlighter-rouge">example</code> module using the BEAM compiler in R14B01,
there will not be any line number information for that module:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">example</span><span class="p">:</span><span class="nf">m</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">not_a_number</span><span class="p">]).</span>
<span class="o">**</span> <span class="n">exception</span> <span class="nn">error</span><span class="p">:</span> <span class="n">bad</span> <span class="n">argument</span>
     <span class="n">in</span> <span class="n">function</span>  <span class="nb">abs</span><span class="o">/</span><span class="mi">1</span>
        <span class="n">called</span> <span class="n">as</span> <span class="nb">abs</span><span class="p">(</span><span class="n">not_a_number</span><span class="p">)</span>
     <span class="n">in</span> <span class="n">call</span> <span class="n">from</span> <span class="nn">example</span><span class="p">:</span><span class="n">f</span><span class="o">/</span><span class="mi">1</span> 
     <span class="n">in</span> <span class="n">call</span> <span class="n">from</span> <span class="nn">lists</span><span class="p">:</span><span class="n">map</span><span class="o">/</span><span class="mi">2</span> <span class="p">(</span><span class="n">lists</span><span class="p">.</span><span class="n">erl</span><span class="p">,</span> <span class="n">line</span> <span class="mi">948</span><span class="p">)</span>
     <span class="n">in</span> <span class="n">call</span> <span class="n">from</span> <span class="nn">lists</span><span class="p">:</span><span class="n">map</span><span class="o">/</span><span class="mi">2</span> <span class="p">(</span><span class="n">lists</span><span class="p">.</span><span class="n">erl</span><span class="p">,</span> <span class="n">line</span> <span class="mi">948</span><span class="p">)</span>
     <span class="n">in</span> <span class="n">call</span> <span class="n">from</span> <span class="nn">example</span><span class="p">:</span><span class="n">m</span><span class="o">/</span><span class="mi">1</span> 
<span class="mi">2</span><span class="o">&gt;</span> <span class="k">catch</span> <span class="nn">example</span><span class="p">:</span><span class="nf">m</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">not_a_number</span><span class="p">]).</span>
<span class="p">{</span><span class="n">'EXIT'</span><span class="p">,{</span><span class="n">badarg</span><span class="p">,[{</span><span class="n">erlang</span><span class="p">,</span><span class="nb">abs</span><span class="p">,[</span><span class="n">not_a_number</span><span class="p">],[]},</span>
                 <span class="p">{</span><span class="n">example</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">,[]},</span>
                 <span class="p">{</span><span class="n">lists</span><span class="p">,</span><span class="n">map</span><span class="p">,</span><span class="mi">2</span><span class="p">,[{</span><span class="n">file</span><span class="p">,</span><span class="s">"lists.erl"</span><span class="p">},{</span><span class="n">line</span><span class="p">,</span><span class="mi">948</span><span class="p">}]},</span>
                 <span class="p">{</span><span class="n">lists</span><span class="p">,</span><span class="n">map</span><span class="p">,</span><span class="mi">2</span><span class="p">,[{</span><span class="n">file</span><span class="p">,</span><span class="s">"lists.erl"</span><span class="p">},{</span><span class="n">line</span><span class="p">,</span><span class="mi">948</span><span class="p">}]},</span>
                 <span class="p">{</span><span class="n">example</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">,[]},</span>
                 <span class="p">{</span><span class="n">erl_eval</span><span class="p">,</span><span class="n">do_apply</span><span class="p">,</span><span class="mi">5</span><span class="p">,[{</span><span class="n">file</span><span class="p">,</span><span class="s">"erl_eval.erl"</span><span class="p">},{</span><span class="n">line</span><span class="p">,</span><span class="mi">482</span><span class="p">}]},</span>
                 <span class="p">{</span><span class="n">erl_eval</span><span class="p">,</span><span class="n">expr</span><span class="p">,</span><span class="mi">5</span><span class="p">,[{</span><span class="n">file</span><span class="p">,</span><span class="s">"erl_eval.erl"</span><span class="p">},{</span><span class="n">line</span><span class="p">,</span><span class="mi">276</span><span class="p">}]},</span>
                 <span class="p">{</span><span class="n">shell</span><span class="p">,</span><span class="n">exprs</span><span class="p">,</span><span class="mi">7</span><span class="p">,[{</span><span class="n">file</span><span class="p">,</span><span class="s">"shell.erl"</span><span class="p">},{</span><span class="n">line</span><span class="p">,</span><span class="mi">666</span><span class="p">}]}]}}</span>
</code></pre></div></div>

<h1 id="motivation">Motivation</h1>

<p>The lack of line number information in exceptions is a major stumbling
block for many beginners, and is a time waster for experienced Erlang
programmers.</p>

<p>An often repeated piece of advice to mitigate the lack of line number
information is to write smaller functions.  To some extent, that is
good advice, but some functions are most naturally written as a single
function with many clauses.  One example is the <code class="language-plaintext highlighter-rouge">handle_call/3</code>
callback for a <code class="language-plaintext highlighter-rouge">gen_server</code> process.  Another example is test suites.
In a typical test suite, every line tests a condition and can
potentially fail.  It is not practical to put every line that may fail
in a separate function.</p>

<p>Test suites based on <code class="language-plaintext highlighter-rouge">common_test</code> are automatically run through a
parse transform that provides line number information when an
exception occurs.  The parse transform inserts before every line code
that saves the current function name and line number in the process
dictionary.  When an exception occurs, the line number can be
retrieved and presented.</p>

<p>One problem with this approach is that the test suite will run slower,
which can cause test cases to fail if timeouts expire in the system
being tested.  Another problem is that by default the parse transform
is only run on the test modules themselves, and therefore exceptions
that occur in other parts of the code (support libraries for testing
or the product itself) does not have any line information.</p>

<h1 id="rationale">Rationale</h1>

<p>We have chosen to let <code class="language-plaintext highlighter-rouge">erlang:get_stacktrace/0</code> and the <code class="language-plaintext highlighter-rouge">catch</code>
operator return stacktraces with filename and line number information
(instead of introducing a new function called, for example,
<code class="language-plaintext highlighter-rouge">erlang:get_full_stacktrace/3</code>).  That means that code that simply
passes on the stacktrace (to <code class="language-plaintext highlighter-rouge">erlang:raise/3</code>) does not need to be
updated.  For example, the following code that catches an exception,
logs it, and pass it on does not need to be updated:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span>
    <span class="nf">some_call_that_may_fail</span><span class="p">()</span>
<span class="k">catch</span>
    <span class="nv">Class</span><span class="p">:</span><span class="nv">Reason</span> <span class="o">-&gt;</span>
        <span class="nv">Stk</span> <span class="o">=</span> <span class="nn">erlang</span><span class="p">:</span><span class="nf">get_stacktrace</span><span class="p">(),</span>
        <span class="nf">log</span><span class="p">(</span><span class="nv">Class</span><span class="p">,</span> <span class="nv">Reason</span><span class="p">,</span> <span class="nv">Stk</span><span class="p">),</span>
        <span class="nn">erlang</span><span class="p">:</span><span class="nf">raise</span><span class="p">(</span><span class="nv">Class</span><span class="p">,</span> <span class="nv">Reason</span><span class="p">,</span> <span class="nv">Stk</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>One the other hand, that means that code that assumes that the
stacktrace only may contain three-tuples will no longer work and needs
to be updated.</p>

<p>There are several reasons for the requirement that the line number
information should be loaded by default (rather than ordered by
giving an option).</p>

<ul>
  <li>
    <p>In real systems, code size is usually not an issue since it is
overshadowed by the memory used for process heaps, off-heap binaries,
and ETS table.  Therefore, the 10 percent increase of the code size
(as measured in the reference implementation) is not an issue for
most users, but the benefit of having line number information is
potentially huge.</p>
  </li>
  <li>
    <p>Newcomers to Erlang have the most need for line number information
and they should get it without giving any special option. If an option
is needed, questions to the mailing lists about how to find from which
source line an exception was caused will continue to waste time.</p>
  </li>
  <li>
    <p>If an option must be given, even developers that know about it may
forget to give it and might therefore end up having to investigate an
exception without line number information. (Which may waste a lot of
time if the problem is not easily reproduce-able.)</p>
  </li>
</ul>

<p>Therefore it is better that the developers that cannot afford any
increase in the size of the loaded code are the ones that must give an
option to turn off loading of line number information.</p>

<h1 id="backwards-compatibility">Backwards Compatibility</h1>

<p>Applications that examine the stacktrace and assume that it contains
three-tuples must be updated. The <code class="language-plaintext highlighter-rouge">erlang:raise/3</code> BIF still accepts
three-tuples (it will translate those to four tuples with an empty
list in the fourth element); thus it is not mandatory to update calls
to <code class="language-plaintext highlighter-rouge">erlang:raise/3</code>.</p>

<h1 id="implementation">Implementation</h1>

<p>The reference implementation can be fetched from Github like this:</p>

<div class="language-erlang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">git</span> <span class="n">fetch</span> <span class="nn">git</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">bjorng</span><span class="o">/</span><span class="n">otp</span><span class="p">.</span><span class="n">git</span> <span class="n">bjorn</span><span class="o">/</span><span class="n">line</span><span class="o">-</span><span class="n">numbers</span><span class="o">-</span><span class="n">in</span><span class="o">-</span><span class="n">exceptions</span>
</code></pre></div></div>

<p>Here is an overview of the implementation:</p>

<p>The BEAM compiler inserts a <code class="language-plaintext highlighter-rouge">line</code> instruction before every construct
that may generate an exception and before every call that will be
included in the stacktrace. (Local tail-recursive calls need no <code class="language-plaintext highlighter-rouge">line</code>
instruction, but external tail-recursive calls need a <code class="language-plaintext highlighter-rouge">line</code>
instruction because they may be calls to BIFs.)</p>

<p>The <code class="language-plaintext highlighter-rouge">line</code> instruction has a single operand, an index into a line
number table.  The line number table is stored in the “Line” chunk in
the BEAM file.  The “Line” chunk and line instructions increase the
file size of BEAM files by about five percent.</p>

<p>The loader will remove the <code class="language-plaintext highlighter-rouge">line</code> instructions from the code that will
be executed, but will remember their location and create a table
sorted in address order mapping from program counter to line number
information.  When a stacktrace needs to be built, the run-time system
will do a binary search for the program counter of exception-causing
instruction and each continuation pointer.</p>

<p>For the benefit of embedded system that run in a very constrained
memory space, the run-time system can be started with the ‘+L’ option
to disable loading of the line number information.  The code will
still be about one percent larger than code compiled without line
number information, because the compiler was unable to do code sharing
optimizations on instructions that cause exceptions (such as the
<code class="language-plaintext highlighter-rouge">badmatch</code> instruction).</p>

<p>In the current implementation, the line number information increases
the size of the loaded code by roughly ten percent.</p>

<h1 id="copyright">Copyright</h1>

<p>This document has been placed in the public domain.</p>


            </div>
        </div>
    </div>
</div>
<script src="/erlang-org/assets/js/prismjs/prism.js"></script>
<script src="/erlang-org/assets/js/prismjs/components/prism-erlang.js"></script>
    <footer class="container-fluid footer text-center border-top border-bottom">
        <div>
            <a href="/erlang-org/downloads.html" title="DOWNLOAD"><img src="/erlang-org/assets/img/download.png"></a>
        </div>
        <div>
            <a href="http://www.github.com/erlang/otp"><img
                    src="/erlang-org/assets/img/GitHub-Mark-32px.png"></a>
        </div>
        
        <div>
            <a href="http://www.twitter.com/erlang_org"><img src="/erlang-org/assets/img/twitter.png"
                    width="32"></a>
        </div>
    </footer>
    <script src="/erlang-org/assets/js/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>